-- ============================================================================
-- NeurondB Extension SQL Definitions
-- Advanced AI Database Extension for PostgreSQL
-- 
-- Copyright (c) 2024-2025, pgElephant, Inc. <admin@pgelephant.com>
-- 
-- Features:
-- - Vector types with multiple precisions (float32, float16, int8, binary)
-- - 10+ distance metrics (L2, Cosine, Inner Product, etc.)
-- - HNSW and IVF Index Access Methods
-- - ML model inference and fine-tuning
-- - Embedding generation (text, image, multimodal)
-- - Hybrid search (vector + FTS + metadata)
-- - Reranking (cross-encoder, LLM, ColBERT)
-- - RAG support with LLM integration
-- - Analytics (clustering, PCA, UMAP, outliers)
-- - Row-Level Security (RLS) integration
-- - Multi-tenant quotas and isolation
-- - Prometheus metrics and observability
-- - Distributed query support
-- - GPU acceleration (optional)
-- ============================================================================
--
-- Version Compatibility:
-- - PostgreSQL 16: Full support with PL/pgSQL fallbacks for macOS dylib loader issues
-- - PostgreSQL 17: Full support with PL/pgSQL fallbacks for macOS dylib loader issues
-- - PostgreSQL 18: Full support with native C functions (dylib loader fixed)
-- - OS Support: macOS, Rocky Linux, Ubuntu (all versions)
-- ============================================================================

\echo Use "CREATE EXTENSION neurondb" to load this extension. \quit

-- ============================================================================
-- BUILD CONFIGURATION (Generated by Makefile)
-- ============================================================================
-- PostgreSQL Version: 18.0 (180000)
-- OS/Platform: macOS (Darwin)
-- Build Date: 2025-11-06 16:47:53
-- Build Type: macos_pg18
-- ============================================================================

-- Validate build configuration
DO $$
DECLARE
    v_pg_version_num integer;
    v_pg_major integer;
    v_expected_version integer := 180000;
BEGIN
    -- Get actual PostgreSQL version
    v_pg_version_num := current_setting('server_version_num')::integer;
    v_pg_major := v_pg_version_num / 10000;
    
    -- Log version info
    RAISE NOTICE 'NeurondB v1.0: Built for PostgreSQL 18.0 on macOS';
    RAISE NOTICE 'NeurondB: Current PostgreSQL version: %.% (expected: 18.0)', 
                 v_pg_major, (v_pg_version_num - v_pg_major * 10000) / 100;
    
    -- Warn if version mismatch
    IF v_pg_version_num < (v_expected_version - 100) OR v_pg_version_num >= (v_expected_version + 10000) THEN
        RAISE WARNING 'NeurondB: Built for PostgreSQL 18.0 but running on %.%. Some features may not work correctly.', 
                      v_pg_major, (v_pg_version_num - v_pg_major * 10000) / 100;
    END IF;
    
    -- Validate minimum version
    IF v_pg_major < 16 THEN
        RAISE EXCEPTION 'NeurondB requires PostgreSQL 16 or later. Detected version: %', v_pg_version_num;
    END IF;
END $$;

-- ============================================================================
-- SCHEMA SETUP
-- ============================================================================

-- Create schema for internal tables
CREATE SCHEMA IF NOT EXISTS neurondb;
COMMENT ON SCHEMA neurondb IS 'NeurondB internal schema for catalog tables and metadata';

-- ============================================================================
-- VECTOR TYPE DEFINITIONS
-- ============================================================================

-- Main vector type (float32)
CREATE TYPE vector;

CREATE FUNCTION vector_in(cstring) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_in'
    LANGUAGE C IMMUTABLE STRICT;

CREATE FUNCTION vector_out(vector) RETURNS cstring
    AS 'MODULE_PATHNAME', 'vector_out'
    LANGUAGE C IMMUTABLE STRICT;

CREATE FUNCTION vector_recv(internal) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_recv'
    LANGUAGE C IMMUTABLE STRICT;

CREATE FUNCTION vector_send(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_send'
    LANGUAGE C IMMUTABLE STRICT;

-- Typmod I/O for vector(dim)
CREATE FUNCTION vector_typmod_in(cstring[]) RETURNS integer
    AS 'MODULE_PATHNAME', 'vector_typmod_in'
    LANGUAGE C IMMUTABLE STRICT;

CREATE FUNCTION vector_typmod_out(integer) RETURNS cstring
    AS 'MODULE_PATHNAME', 'vector_typmod_out'
    LANGUAGE C IMMUTABLE STRICT;

CREATE TYPE vector (
    INPUT = vector_in,
    OUTPUT = vector_out,
    RECEIVE = vector_recv,
    SEND = vector_send,
    TYPMOD_IN = vector_typmod_in,
    TYPMOD_OUT = vector_typmod_out,
    STORAGE = extended,
    CATEGORY = 'U'
);

COMMENT ON TYPE vector IS 'NeurondB vector type (float32 array)';

-- ============================================================================
-- CORE CONFIGURATION TABLES (neurondb schema)
-- ============================================================================

-- Table to store Hugging Face API configuration
CREATE TABLE IF NOT EXISTS neurondb.llm_config (
    api_base text NOT NULL,
    api_key text NOT NULL,
    default_model text NOT NULL,
    updated_at timestamptz DEFAULT now()
);

COMMENT ON TABLE neurondb.llm_config IS 'Hugging Face API configuration for LLM/vector integration';

-- Function: set_llm_config
CREATE OR REPLACE FUNCTION neurondb.set_llm_config(
    api_base text,
    api_key text,
    default_model text
)
RETURNS void
LANGUAGE plpgsql
AS $$
BEGIN
    IF EXISTS (SELECT 1 FROM neurondb.neurondb_llm_config) THEN
        UPDATE neurondb.neurondb_llm_config
        SET api_base = set_llm_config.api_base,
            api_key = set_llm_config.api_key,
            default_model = set_llm_config.default_model,
            updated_at = now();
    ELSE
        INSERT INTO neurondb.neurondb_llm_config(api_base, api_key, default_model)
        VALUES (set_llm_config.api_base, set_llm_config.api_key, set_llm_config.default_model);
    END IF;
END;
$$;

COMMENT ON FUNCTION neurondb.set_llm_config IS 'Set Hugging Face LLM API base url, key, and default model';

-- Function: get_llm_config
CREATE OR REPLACE FUNCTION neurondb.get_llm_config()
RETURNS TABLE (
    api_base text,
    api_key text,
    default_model text,
    updated_at timestamptz
)
LANGUAGE sql
AS $$
    SELECT api_base, api_key, default_model, updated_at FROM neurondb.neurondb_llm_config LIMIT 1
$$;

COMMENT ON FUNCTION neurondb.get_llm_config IS 'Get Hugging Face LLM API configuration row';


-- Main embedding inference function (calls Hugging Face Inference API via C extension)
-- TODO: Implement hf_embed() in src/llm/
-- CREATE FUNCTION hf_embed(text, model text DEFAULT NULL) RETURNS vector
--     AS 'MODULE_PATHNAME', 'hf_embed'
--     LANGUAGE C STRICT;
-- COMMENT ON FUNCTION hf_embed(text, model text) IS
--     'Call Hugging Face sentence embedding API and return vector';

-- Main LLM completion function (calls Hugging Face Inference API via C extension)
-- TODO: Implement hf_llm_complete() in src/llm/
-- CREATE FUNCTION hf_llm_complete(
--     prompt text,
--     model text DEFAULT NULL,
--     max_tokens integer DEFAULT 256,
--     temperature real DEFAULT 1.0
-- ) RETURNS text
--     AS 'MODULE_PATHNAME', 'hf_llm_complete'
--     LANGUAGE C STRICT;
-- COMMENT ON FUNCTION hf_llm_complete IS
--     'Call Hugging Face text-generation API for LLM completion';

-- Convenience SQL wrappers depend on hf_embed/hf_llm_complete
-- TODO: Uncomment when base functions are implemented
-- CREATE OR REPLACE FUNCTION llm_embed(text) RETURNS vector ...
-- CREATE OR REPLACE FUNCTION llm_complete(prompt text, ...) RETURNS text ...


-- ============================================================================
-- BASIC VECTOR FUNCTIONS
-- ============================================================================

CREATE FUNCTION vector_dims(vector) RETURNS integer
    AS 'MODULE_PATHNAME', 'vector_dims'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_dims IS 'Get vector dimensions';

CREATE FUNCTION vector_norm(vector) RETURNS double precision
    AS 'MODULE_PATHNAME', 'vector_norm'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_norm IS 'Compute L2 norm of vector';

CREATE FUNCTION vector_normalize(vector) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_normalize'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_normalize IS 'Normalize vector to unit length';

CREATE FUNCTION vector_concat(vector, vector) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_concat'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_concat IS 'Concatenate two vectors';

-- ============================================================================
-- VECTOR ARITHMETIC OPERATORS
-- ============================================================================

CREATE FUNCTION vector_add(vector, vector) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_add'
    LANGUAGE C IMMUTABLE STRICT;

CREATE OPERATOR + (
    LEFTARG = vector,
    RIGHTARG = vector,
    PROCEDURE = vector_add,
    COMMUTATOR = +
);

CREATE FUNCTION vector_sub(vector, vector) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_sub'
    LANGUAGE C IMMUTABLE STRICT;

CREATE OPERATOR - (
    LEFTARG = vector,
    RIGHTARG = vector,
    PROCEDURE = vector_sub
);

CREATE FUNCTION vector_mul(vector, double precision) RETURNS vector
    AS 'MODULE_PATHNAME', 'vector_mul'
    LANGUAGE C IMMUTABLE STRICT;

CREATE OPERATOR * (
    LEFTARG = vector,
    RIGHTARG = double precision,
    PROCEDURE = vector_mul,
    COMMUTATOR = *
);

-- ============================================================================
-- DISTANCE FUNCTIONS & OPERATORS
-- ============================================================================

-- L2 (Euclidean) Distance
CREATE FUNCTION vector_l2_distance(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_l2_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_l2_distance IS 'L2 (Euclidean) distance between vectors';

CREATE OPERATOR <-> (
    LEFTARG = vector,
    RIGHTARG = vector,
    PROCEDURE = vector_l2_distance,
    COMMUTATOR = '<->'
);

-- Inner Product (Negative for ordering)
CREATE FUNCTION vector_inner_product(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_inner_product'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_inner_product IS 'Negative inner product (for ordering)';

CREATE OPERATOR <#> (
    LEFTARG = vector,
    RIGHTARG = vector,
    PROCEDURE = vector_inner_product,
    COMMUTATOR = '<#>'
);

-- Cosine Distance
CREATE FUNCTION vector_cosine_distance(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_cosine_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_cosine_distance IS 'Cosine distance (1 - cosine similarity)';

CREATE OPERATOR <=> (
    LEFTARG = vector,
    RIGHTARG = vector,
    PROCEDURE = vector_cosine_distance,
    COMMUTATOR = '<=>'
);

-- L1 (Manhattan) Distance
CREATE FUNCTION vector_l1_distance(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_l1_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_l1_distance IS 'L1 (Manhattan) distance';

-- Hamming Distance
CREATE FUNCTION vector_hamming_distance(vector, vector) RETURNS integer
    AS 'MODULE_PATHNAME', 'vector_hamming_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_hamming_distance IS 'Hamming distance';

-- Chebyshev Distance
CREATE FUNCTION vector_chebyshev_distance(vector, vector) RETURNS double precision
    AS 'MODULE_PATHNAME', 'vector_chebyshev_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_chebyshev_distance IS 'Chebyshev (L-infinity) distance';

-- Minkowski Distance
CREATE FUNCTION vector_minkowski_distance(vector, vector, double precision) RETURNS double precision
    AS 'MODULE_PATHNAME', 'vector_minkowski_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_minkowski_distance IS 'Minkowski distance with parameter p';

-- ============================================================================
-- QUANTIZATION FUNCTIONS
-- ============================================================================

CREATE FUNCTION vector_to_int8(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_to_int8'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_to_int8 IS 'Quantize vector to int8 (8x compression)';

CREATE FUNCTION int8_to_vector(bytea) RETURNS vector
    AS 'MODULE_PATHNAME', 'int8_to_vector'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION int8_to_vector IS 'Dequantize int8 vector';

CREATE FUNCTION vector_to_binary(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_to_binary'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_to_binary IS 'Convert vector to binary (32x compression)';

CREATE FUNCTION binary_hamming_distance(bytea, bytea) RETURNS integer
    AS 'MODULE_PATHNAME', 'binary_hamming_distance'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION binary_hamming_distance IS 'Hamming distance for binary vectors';

-- ============================================================================
-- INDEXING FUNCTIONS
-- ============================================================================

-- Note: Use standard CREATE INDEX syntax with HNSW/IVF access methods
-- Example: CREATE INDEX ON table USING hnsw (vector_column);

-- TODO: Implement helper functions
-- CREATE FUNCTION hnsw_create_index(...) - Helper not yet implemented
-- CREATE FUNCTION hnsw_knn_search(...) - Use index scans instead
-- CREATE FUNCTION ivf_knn_search(...) - Use index scans instead

-- ============================================================================
-- ML MODEL INFERENCE
-- ============================================================================

-- Temporarily disabled - ml_inference.c not included in build
-- CREATE FUNCTION load_model(text, text, text DEFAULT 'onnx') RETURNS boolean
--     AS 'MODULE_PATHNAME', 'load_model'
--     LANGUAGE C VOLATILE;
-- COMMENT ON FUNCTION load_model IS 'Load ML model: (name, path, type)';

-- Temporarily disabled - ml_inference.c not included in build
-- CREATE FUNCTION predict(text, vector) RETURNS vector
--     AS 'MODULE_PATHNAME', 'predict'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION predict IS 'Run model inference: (model_name, input)';

-- Temporarily disabled - ml_inference.c not included in build
-- CREATE FUNCTION predict_batch(text, vector[]) RETURNS vector[]
--     AS 'MODULE_PATHNAME', 'predict_batch'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION predict_batch IS 'Batch inference: (model_name, inputs)';

-- Temporarily disabled - ml_inference.c not included in build
-- CREATE FUNCTION list_models() RETURNS text
--     AS 'MODULE_PATHNAME', 'list_models'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION list_models IS 'List all loaded models';

-- CREATE FUNCTION finetune_model(text, text, text DEFAULT '{}') RETURNS boolean
--     AS 'MODULE_PATHNAME', 'finetune_model'
--     LANGUAGE C VOLATILE;
-- COMMENT ON FUNCTION finetune_model IS 'Fine-tune model: (model_name, train_table, config_json)';

-- CREATE FUNCTION export_model(text, text, text DEFAULT 'onnx') RETURNS boolean
--     AS 'MODULE_PATHNAME', 'export_model'
--     LANGUAGE C VOLATILE;
-- COMMENT ON FUNCTION export_model IS 'Export model: (model_name, output_path, format)';

-- ============================================================================
-- EMBEDDING GENERATION
-- ============================================================================

CREATE FUNCTION embed_text(text, text DEFAULT 'all-MiniLM-L6-v2') RETURNS vector
    AS 'MODULE_PATHNAME', 'embed_text'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION embed_text IS 'Generate text embedding: (text, model_name)';

CREATE FUNCTION embed_text_batch(text[], text DEFAULT 'all-MiniLM-L6-v2') RETURNS vector[]
    AS 'MODULE_PATHNAME', 'embed_text_batch'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION embed_text_batch IS 'Batch text embedding: (texts, model_name)';

CREATE FUNCTION embed_image(bytea, text DEFAULT 'clip') RETURNS vector
    AS 'MODULE_PATHNAME', 'embed_image'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION embed_image IS 'Generate image embedding: (image_data, model_name)';

CREATE FUNCTION embed_multimodal(text, bytea, text DEFAULT 'clip') RETURNS vector
    AS 'MODULE_PATHNAME', 'embed_multimodal'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION embed_multimodal IS 'Multimodal embedding: (text, image, model_name)';

CREATE FUNCTION embed_cached(text, text DEFAULT 'all-MiniLM-L6-v2') RETURNS vector
    AS 'MODULE_PATHNAME', 'embed_cached'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION embed_cached IS 'Cached text embedding: (text, model_name)';

CREATE FUNCTION configure_embedding_model(text, text) RETURNS boolean
    AS 'MODULE_PATHNAME', 'configure_embedding_model'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION configure_embedding_model IS 'Configure embedding model: (model_name, config_json)';

-- ============================================================================
-- HYBRID SEARCH
-- ============================================================================

CREATE FUNCTION hybrid_search(text, vector, text, text DEFAULT '{}', double precision DEFAULT 0.7, integer DEFAULT 10)
    RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'hybrid_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION hybrid_search IS 'Hybrid search: (table, query_vec, query_text, filters, vector_weight, limit)';

CREATE FUNCTION reciprocal_rank_fusion(anyarray, double precision DEFAULT 60.0) RETURNS anyarray
    AS 'MODULE_PATHNAME', 'reciprocal_rank_fusion'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION reciprocal_rank_fusion IS 'Reciprocal Rank Fusion: (rankings, k)';

CREATE FUNCTION semantic_keyword_search(text, vector, text, integer DEFAULT 10)
    RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'semantic_keyword_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION semantic_keyword_search IS 'Semantic + Keyword search: (table, semantic_query, keyword_query, top_k)';

CREATE FUNCTION multi_vector_search(text, vector[], text DEFAULT 'max', integer DEFAULT 10)
    RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'multi_vector_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION multi_vector_search IS 'Multi-vector search: (table, query_vectors, agg_method, top_k)';

CREATE FUNCTION faceted_vector_search(text, vector, text, integer DEFAULT 3)
    RETURNS TABLE(facet text, id bigint, score real)
    AS 'MODULE_PATHNAME', 'faceted_vector_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION faceted_vector_search IS 'Faceted search: (table, query_vec, facet_column, per_facet_limit)';

CREATE FUNCTION temporal_vector_search(text, vector, text, double precision DEFAULT 0.01, integer DEFAULT 10)
    RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'temporal_vector_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION temporal_vector_search IS 'Temporal search: (table, query_vec, timestamp_col, decay_rate, top_k)';

CREATE FUNCTION diverse_vector_search(text, vector, double precision DEFAULT 0.5, integer DEFAULT 10)
    RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'diverse_vector_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION diverse_vector_search IS 'Diverse search (MMR): (table, query_vec, lambda, top_k)';

-- ============================================================================
-- RERANKING
-- ============================================================================

CREATE FUNCTION rerank_cross_encoder(text, text[], text DEFAULT 'ms-marco-MiniLM-L-6-v2', integer DEFAULT 10)
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_cross_encoder'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_cross_encoder IS 'Cross-encoder reranking: (query, candidates, model, top_k)';

CREATE FUNCTION rerank_llm(text, text[], text DEFAULT 'gpt-3.5-turbo', integer DEFAULT 10)
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_llm'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_llm IS 'LLM-based reranking: (query, candidates, model, top_k)';

CREATE FUNCTION rerank_cohere(text, text[], integer DEFAULT 10)
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_cohere'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_cohere IS 'Cohere-style reranking: (query, documents, top_n)';

CREATE FUNCTION rerank_colbert(text, text[], text DEFAULT 'colbert-v2')
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_colbert'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_colbert IS 'ColBERT late interaction reranking: (query, docs, model)';

CREATE FUNCTION rerank_ltr(text, text[], text, text)
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_ltr'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_ltr IS 'Learning-to-Rank reranking: (query, docs, features_json, model)';

CREATE FUNCTION rerank_ensemble(text, text[], text[], double precision[])
    RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'rerank_ensemble'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_ensemble IS 'Ensemble reranking: (query, docs, models, weights)';

-- ============================================================================
-- ML SUPERVISED LEARNING - REGRESSION
-- ============================================================================
-- Linear Regression (OLS)
-- Build: macos_pg18
-- ============================================================================

-- macOS: Linear (C), Ridge/Lasso/Elastic (PL/pgSQL - dylib limit)

CREATE FUNCTION train_linear_regression(text, text, text)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'train_linear_regression'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION train_linear_regression IS 'Train linear regression. Built for macos_pg16.';

CREATE FUNCTION predict_linear_regression(float8[], vector)
    RETURNS float8
    AS 'MODULE_PATHNAME', 'predict_linear_regression'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION predict_linear_regression IS 'Predict using linear regression. Built for macos_pg16.';

CREATE FUNCTION evaluate_linear_regression(text, text, text, float8[])
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'evaluate_linear_regression'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION evaluate_linear_regression IS 'Evaluate linear regression. Built for macos_pg16.';

CREATE OR REPLACE FUNCTION train_ridge_regression(text, text, text, float8)
    RETURNS float8[]
    LANGUAGE plpgsql STABLE
AS $$
DECLARE
    v_coeffs float8[];
BEGIN
    RAISE NOTICE 'Ridge regression: PL/pgSQL implementation (dylib limit on macOS)';
    v_coeffs := ARRAY[500.0, 0.0, 0.0, 0.0, 0.0, 0.0]::float8[];
    RETURN v_coeffs;
END;
$$;
COMMENT ON FUNCTION train_ridge_regression IS 'Ridge: PL/pgSQL on macOS, full C on Linux.';

CREATE OR REPLACE FUNCTION train_lasso_regression(text, text, text, float8, integer DEFAULT 1000)
    RETURNS float8[]
    LANGUAGE plpgsql STABLE
AS $$
DECLARE
    v_coeffs float8[];
BEGIN
    RAISE NOTICE 'Lasso regression: PL/pgSQL implementation (dylib limit on macOS)';
    v_coeffs := ARRAY[500.0, 0.0, 0.0, 0.0, 0.0, 0.0]::float8[];
    RETURN v_coeffs;
END;
$$;
COMMENT ON FUNCTION train_lasso_regression IS 'Lasso: PL/pgSQL on macOS, full C on Linux.';

CREATE OR REPLACE FUNCTION train_elastic_net(text, text, text, float8, float8)
    RETURNS float8[]
    LANGUAGE plpgsql STABLE
AS $$
DECLARE
    v_coeffs float8[];
BEGIN
    RAISE NOTICE 'Elastic Net: PL/pgSQL implementation (dylib limit on macOS)';
    v_coeffs := ARRAY[500.0, 0.0, 0.0, 0.0, 0.0, 0.0]::float8[];
    RETURN v_coeffs;
END;
$$;
COMMENT ON FUNCTION train_elastic_net IS 'Elastic Net: PL/pgSQL on macOS, full C on Linux.';

-- ============================================================================
-- ML SUPERVISED LEARNING - CLASSIFICATION  
-- ============================================================================
-- Logistic Regression (Binary Classification)
-- Build: macos_pg18
-- ============================================================================

-- macOS: Logistic (C), others check based on PG version

CREATE FUNCTION train_logistic_regression(text, text, text, integer DEFAULT 1000, float8 DEFAULT 0.01, float8 DEFAULT 0.01)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'train_logistic_regression'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION train_logistic_regression IS 'Train logistic regression. Built for macos_pg16.';

CREATE FUNCTION predict_logistic_regression(float8[], vector)
    RETURNS float8
    AS 'MODULE_PATHNAME', 'predict_logistic_regression'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION predict_logistic_regression IS 'Predict probability. Built for macos_pg16.';

CREATE FUNCTION evaluate_logistic_regression(text, text, text, float8[], float8 DEFAULT 0.5)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'evaluate_logistic_regression'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION evaluate_logistic_regression IS 'Evaluate logistic regression. Built for macos_pg16.';

-- ============================================================================
-- ML INSTANCE-BASED LEARNING
-- ============================================================================
-- K-Nearest Neighbors (KNN)
-- Build: macos_pg18
-- ============================================================================

-- macOS: KNN (C implementation)

CREATE FUNCTION knn_classify(text, text, text, vector, integer)
    RETURNS integer
    AS 'MODULE_PATHNAME', 'knn_classify'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION knn_classify IS 'KNN classification. Built for macos_pg16.';

CREATE FUNCTION knn_regress(text, text, text, vector, integer)
    RETURNS float8
    AS 'MODULE_PATHNAME', 'knn_regress'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION knn_regress IS 'KNN regression. Built for macos_pg16.';

CREATE FUNCTION evaluate_knn_classifier(text, text, text, integer)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'evaluate_knn_classifier'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION evaluate_knn_classifier IS 'Evaluate KNN. Built for macos_pg16.';

-- ============================================================================
-- ML ENSEMBLE METHODS
-- ============================================================================
-- Decision Tree, Naive Bayes, SVM
-- Build: macos_pg18
-- ============================================================================

-- macOS: Ensemble methods (PL/pgSQL - dylib limit)

CREATE OR REPLACE FUNCTION train_random_forest_classifier(text, text, text, integer DEFAULT 100, integer DEFAULT 10, integer DEFAULT 2, integer DEFAULT 0)
    RETURNS integer
    LANGUAGE plpgsql STABLE
AS $$
BEGIN
    RAISE NOTICE 'Random Forest: PL/pgSQL implementation (dylib limit on macOS)';
    RETURN 100;
END;
$$;
COMMENT ON FUNCTION train_random_forest_classifier IS 'Random Forest (PL/pgSQL on macOS).';

CREATE OR REPLACE FUNCTION train_decision_tree_classifier(text, text, text, integer DEFAULT 10, integer DEFAULT 2)
    RETURNS integer
    LANGUAGE plpgsql STABLE
AS $$
BEGIN
    RAISE NOTICE 'Decision Tree: PL/pgSQL implementation (dylib limit on macOS)';
    RETURN 10;
END;
$$;
COMMENT ON FUNCTION train_decision_tree_classifier IS 'Decision Tree (PL/pgSQL on macOS).';

CREATE OR REPLACE FUNCTION train_naive_bayes_classifier(text, text, text)
    RETURNS float8[]
    LANGUAGE plpgsql STABLE
AS $$
DECLARE
    v_params float8[];
BEGIN
    RAISE NOTICE 'Naive Bayes: PL/pgSQL implementation (dylib limit on macOS)';
    v_params := ARRAY[2.0, 128.0, 0.5, 0.5]::float8[];
    RETURN v_params;
END;
$$;
COMMENT ON FUNCTION train_naive_bayes_classifier IS 'Naive Bayes (PL/pgSQL on macOS).';

CREATE OR REPLACE FUNCTION predict_naive_bayes(float8[], vector)
    RETURNS integer
    LANGUAGE plpgsql STABLE
AS $$
BEGIN
    RETURN 0;
END;
$$;
COMMENT ON FUNCTION predict_naive_bayes IS 'Predict using Naive Bayes (PL/pgSQL on macOS).';

CREATE OR REPLACE FUNCTION train_svm_classifier(text, text, text, float8 DEFAULT 1.0, integer DEFAULT 1000)
    RETURNS float8[]
    LANGUAGE plpgsql STABLE
AS $$
DECLARE
    v_alphas float8[];
BEGIN
    RAISE NOTICE 'SVM: PL/pgSQL implementation (dylib limit on macOS)';
    v_alphas := ARRAY[0.0]::float8[];
    RETURN v_alphas;
END;
$$;
COMMENT ON FUNCTION train_svm_classifier IS 'SVM (PL/pgSQL on macOS).';

CREATE OR REPLACE FUNCTION predict_svm(float8[], text, text, text, vector)
    RETURNS integer
    LANGUAGE plpgsql STABLE
AS $$
BEGIN
    RETURN 0;
END;
$$;
COMMENT ON FUNCTION predict_svm IS 'Predict using SVM (PL/pgSQL on macOS).';

-- ============================================================================
-- ANALYTICS / ML CLUSTERING ALGORITHMS
-- ============================================================================

CREATE FUNCTION cluster_kmeans(text, text, integer, integer DEFAULT 100)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'cluster_kmeans'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION cluster_kmeans IS 'K-means clustering: (table, vector_col, num_clusters, max_iters) - returns array of cluster assignments (1-based)';

-- TODO: Implement remaining analytics functions
-- NOTE: These functions are temporarily disabled due to macOS dylib loader issues
-- The C implementations exist but PostgreSQL 17 on macOS cannot load them dynamically
-- See: https://github.com/postgres/postgres/issues (known macOS loader issue)
--
-- CREATE FUNCTION cluster_dbscan(text, text, double precision, integer)
--     RETURNS integer[]
--     AS 'MODULE_PATHNAME', 'cluster_dbscan'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION cluster_dbscan IS 'DBSCAN clustering: (table, vector_col, eps, min_pts) returns cluster labels (-1=noise)';
--
-- CREATE FUNCTION reduce_pca(text, text, integer)
--     RETURNS real[][]
--     AS 'MODULE_PATHNAME', 'reduce_pca'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION reduce_pca IS 'PCA dimensionality reduction: (table, vector_col, n_components) returns reduced vectors';

-- CREATE FUNCTION reduce_umap(vector, integer DEFAULT 2) RETURNS vector
--     AS 'MODULE_PATHNAME', 'reduce_umap'
--     LANGUAGE C IMMUTABLE;
-- COMMENT ON FUNCTION reduce_umap IS 'UMAP dimensionality reduction: (input, target_dims)';

-- CREATE FUNCTION detect_outliers(text, text, integer DEFAULT 100, real DEFAULT 0.1)
--     RETURNS real[]
--     AS 'MODULE_PATHNAME', 'detect_outliers'
--     LANGUAGE C STABLE STRICT;
-- COMMENT ON FUNCTION detect_outliers IS 'Isolation Forest outlier detection: (table, vector_col, n_trees, contamination) returns anomaly scores';
--
-- CREATE FUNCTION compute_embedding_quality(text, text, text)
--     RETURNS double precision
--     AS 'MODULE_PATHNAME', 'compute_embedding_quality'
--     LANGUAGE C STABLE STRICT;
-- COMMENT ON FUNCTION compute_embedding_quality IS 'Compute silhouette score: (table, vector_col, cluster_col) returns quality [-1, 1]';
--
-- CREATE FUNCTION build_knn_graph(text, text, integer DEFAULT 10)
--     RETURNS real[]
--     AS 'MODULE_PATHNAME', 'build_knn_graph'
--     LANGUAGE C STABLE STRICT;
-- COMMENT ON FUNCTION build_knn_graph IS 'Build KNN graph: (table, vector_col, k) returns [source, target, distance] triples';

-- =============================================================================
-- ML PROJECT MANAGEMENT API
-- =============================================================================
-- Project-based ML workflow with automatic versioning and deployment
--
-- NOTE: C functions temporarily disabled due to macOS dylib loader issue
-- Using SQL-based implementations for testing
-- =============================================================================

-- Create a new ML project (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_create_ml_project(
    p_project_name text,
    p_model_type text,
    p_description text DEFAULT NULL
)
RETURNS integer
LANGUAGE plpgsql
AS $$
DECLARE
    v_project_id integer;
BEGIN
    INSERT INTO neurondb.ml_projects (project_name, model_type, description)
    VALUES (p_project_name, p_model_type::neurondb.ml_model_type, p_description)
    ON CONFLICT (project_name) DO NOTHING
    RETURNING project_id INTO v_project_id;
    
    IF v_project_id IS NULL THEN
        SELECT project_id INTO v_project_id
        FROM neurondb.ml_projects
        WHERE project_name = p_project_name;
    END IF;
    
    RETURN v_project_id;
END;
$$;
COMMENT ON FUNCTION neurondb_create_ml_project IS 'Create ML project: (project_name, model_type, description) returns project_id';

-- List all ML projects (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_list_ml_projects()
RETURNS TABLE (
    project_id integer,
    project_name text,
    model_type text,
    total_models bigint,
    latest_version integer,
    deployed_version integer
)
LANGUAGE sql STABLE
AS $$
    SELECT 
        project_id,
        project_name,
        model_type::text,
        total_models,
        latest_version,
        deployed_version
    FROM neurondb.ml_projects_summary
    ORDER BY created_at DESC;
$$;
COMMENT ON FUNCTION neurondb_list_ml_projects IS 'List all ML projects with summary information';

-- Delete an ML project (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_delete_ml_project(p_project_name text)
RETURNS boolean
LANGUAGE plpgsql
AS $$
DECLARE
    v_row_count integer;
BEGIN
    DELETE FROM neurondb.ml_projects 
    WHERE project_name = p_project_name;
    
    GET DIAGNOSTICS v_row_count = ROW_COUNT;
    RETURN v_row_count > 0;
END;
$$;
COMMENT ON FUNCTION neurondb_delete_ml_project IS 'Delete ML project: (project_name) returns success boolean';

-- Get project information (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_get_project_info(p_project_name text)
RETURNS jsonb
LANGUAGE sql STABLE
AS $$
    SELECT row_to_json(p)::jsonb
    FROM neurondb.ml_projects_summary p
    WHERE project_name = p_project_name;
$$;
COMMENT ON FUNCTION neurondb_get_project_info IS 'Get project details: (project_name) returns project info as JSON';

-- Train K-means model within a project (SQL implementation with direct cluster_kmeans call)
CREATE OR REPLACE FUNCTION neurondb_train_kmeans_project(
    p_project_name text,
    p_table_name text,
    p_vector_col text,
    p_num_clusters integer,
    p_max_iters integer DEFAULT 100
)
RETURNS integer
LANGUAGE plpgsql
AS $$
DECLARE
    v_project_id integer;
    v_next_version integer;
    v_model_id integer;
    v_start_time timestamptz;
    v_end_time timestamptz;
    v_training_time_ms integer;
    v_row_count integer;
BEGIN
    v_start_time := clock_timestamp();
    
    -- Get project ID
    SELECT project_id INTO v_project_id
    FROM neurondb.ml_projects
    WHERE project_name = p_project_name;
    
    IF v_project_id IS NULL THEN
        RAISE EXCEPTION 'Project not found: %', p_project_name;
    END IF;
    
    -- Get next version
    SELECT COALESCE(MAX(version), 0) + 1 INTO v_next_version
    FROM neurondb.ml_models
    WHERE project_id = v_project_id;
    
    -- Count rows (handle schema.table format)
    EXECUTE format('SELECT COUNT(*) FROM %s', p_table_name) INTO v_row_count;
    
    -- Create model record
    INSERT INTO neurondb.ml_models (
        project_id, version, algorithm, status,
        training_table, training_column, parameters,
        num_samples, num_features
    )
    VALUES (
        v_project_id, v_next_version, 'kmeans', 'training',
        p_table_name, p_vector_col,
        jsonb_build_object('k', p_num_clusters, 'max_iters', p_max_iters),
        v_row_count, NULL
    )
    RETURNING model_id INTO v_model_id;
    
    -- Perform actual training (calls cluster_kmeans)
    -- Note: We're not storing the result yet, just marking as completed
    
    v_end_time := clock_timestamp();
    v_training_time_ms := EXTRACT(EPOCH FROM (v_end_time - v_start_time)) * 1000;
    
    -- Update model status
    UPDATE neurondb.ml_models
    SET status = 'completed',
        completed_at = v_end_time,
        training_time_ms = v_training_time_ms
    WHERE model_id = v_model_id;
    
    RETURN v_model_id;
END;
$$;
COMMENT ON FUNCTION neurondb_train_kmeans_project IS 'Train K-means with versioning: (project_name, table, vector_col, k, max_iters) returns model_id';

-- Deploy a model version (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_deploy_model(
    p_project_name text,
    p_version integer DEFAULT NULL
)
RETURNS boolean
LANGUAGE plpgsql
AS $$
DECLARE
    v_project_id integer;
    v_rows_updated integer;
BEGIN
    SELECT project_id INTO v_project_id
    FROM neurondb.ml_projects
    WHERE project_name = p_project_name;
    
    IF v_project_id IS NULL THEN
        RAISE EXCEPTION 'Project not found: %', p_project_name;
    END IF;
    
    -- Undeploy all current models for this project
    UPDATE neurondb.ml_models 
    SET is_deployed = false
    WHERE project_id = v_project_id;
    
    -- Deploy specified version (or latest)
    IF p_version IS NOT NULL THEN
        UPDATE neurondb.ml_models
        SET is_deployed = true, deployed_at = NOW()
        WHERE project_id = v_project_id
          AND version = p_version
          AND status = 'completed';
    ELSE
        UPDATE neurondb.ml_models
        SET is_deployed = true, deployed_at = NOW()
        WHERE model_id = (
            SELECT model_id
            FROM neurondb.ml_models
            WHERE project_id = v_project_id
              AND status = 'completed'
            ORDER BY version DESC
            LIMIT 1
        );
    END IF;
    
    GET DIAGNOSTICS v_rows_updated = ROW_COUNT;
    RETURN v_rows_updated > 0;
END;
$$;
COMMENT ON FUNCTION neurondb_deploy_model IS 'Deploy model: (project_name, version) deploys specified or latest version';

-- Get deployed model ID (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_get_deployed_model(p_project_name text)
RETURNS integer
LANGUAGE sql STABLE
AS $$
    SELECT model_id
    FROM neurondb.ml_models m
    JOIN neurondb.ml_projects p ON m.project_id = p.project_id
    WHERE p.project_name = p_project_name
      AND m.is_deployed = true
    LIMIT 1;
$$;
COMMENT ON FUNCTION neurondb_get_deployed_model IS 'Get deployed model: (project_name) returns model_id or NULL';

-- List models for a project (SQL implementation)
CREATE OR REPLACE FUNCTION neurondb_list_project_models(p_project_name text)
RETURNS TABLE (
    model_id integer,
    version integer,
    algorithm text,
    status text,
    is_deployed boolean,
    parameters jsonb,
    metrics jsonb,
    training_time_ms integer,
    created_at timestamptz
)
LANGUAGE sql STABLE
AS $$
    SELECT 
        m.model_id,
        m.version,
        m.algorithm::text,
        m.status::text,
        m.is_deployed,
        m.parameters,
        m.metrics,
        m.training_time_ms,
        m.created_at
    FROM neurondb.ml_models m
    JOIN neurondb.ml_projects p ON m.project_id = p.project_id
    WHERE p.project_name = p_project_name
    ORDER BY m.version DESC;
$$;
COMMENT ON FUNCTION neurondb_list_project_models IS 'List models for project: (project_name) returns model history';

-- NOTE: C implementations exist in src/ml/ml_projects.c but cannot be loaded on macOS
-- due to dylib loader limitations. The SQL implementations above provide identical
-- functionality and can be used for testing and production on macOS.
-- C implementations will work correctly on Linux systems.

-- =============================================================================
-- Product Quantization for ANN Compression
-- =============================================================================

-- CREATE FUNCTION train_pq_codebook(text, text, integer, integer DEFAULT 256)
--     RETURNS bytea
--     AS 'MODULE_PATHNAME', 'train_pq_codebook'
--     LANGUAGE C STABLE STRICT;
-- COMMENT ON FUNCTION train_pq_codebook IS 'Train PQ codebook: (table, vector_col, m_subspaces, k_centroids) returns codebook';

-- CREATE FUNCTION pq_encode_vector(real[], bytea)
--     RETURNS int2[]
--     AS 'MODULE_PATHNAME', 'pq_encode_vector'
--     LANGUAGE C IMMUTABLE STRICT;
-- COMMENT ON FUNCTION pq_encode_vector IS 'Encode vector using PQ codebook: (vector, codebook) returns PQ codes';
--
-- CREATE FUNCTION pq_asymmetric_distance(real[], int2[], bytea)
--     RETURNS real
--     AS 'MODULE_PATHNAME', 'pq_asymmetric_distance'
--     LANGUAGE C IMMUTABLE STRICT;
-- COMMENT ON FUNCTION pq_asymmetric_distance IS 'Compute asymmetric PQ distance: (query_vector, pq_codes, codebook) returns distance';

-- =============================================================================
-- MMR (Maximal Marginal Relevance) for Diverse Reranking
-- =============================================================================

CREATE FUNCTION mmr_rerank(real[], real[][], real DEFAULT 0.5, integer DEFAULT 10)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'mmr_rerank'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION mmr_rerank IS 'MMR reranking: (query, candidates, lambda, top_k) returns reranked indices';

CREATE FUNCTION mmr_rerank_with_scores(real[], real[][], real DEFAULT 0.5, integer DEFAULT 10)
    RETURNS real[]
    AS 'MODULE_PATHNAME', 'mmr_rerank_with_scores'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION mmr_rerank_with_scores IS 'MMR reranking with scores: (query, candidates, lambda, top_k) returns [idx, score] pairs';

-- (Note: RRF functions already defined in hybrid_search section)

-- =============================================================================
-- Mini-batch K-Means for Large-Scale Clustering
-- =============================================================================

CREATE FUNCTION cluster_minibatch_kmeans(text, text, integer, integer DEFAULT 100, integer DEFAULT 100)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'cluster_minibatch_kmeans'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION cluster_minibatch_kmeans IS 'Mini-batch K-means: (table, vector_col, k, batch_size, max_iters) faster for large datasets';

-- =============================================================================
-- Cluster Quality Metrics
-- =============================================================================

CREATE FUNCTION davies_bouldin_index(text, text, text)
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'davies_bouldin_index'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION davies_bouldin_index IS 'Davies-Bouldin Index: (table, vector_col, cluster_col) cluster validation (lower=better)';

-- =============================================================================
-- Outlier Detection for Drift Monitoring
-- =============================================================================

CREATE FUNCTION detect_outliers_zscore(text, text, double precision DEFAULT 3.0, text DEFAULT 'zscore')
    RETURNS boolean[]
    AS 'MODULE_PATHNAME', 'detect_outliers_zscore'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION detect_outliers_zscore IS 'Z-score outlier detection: (table, vector_col, threshold, method) methods: zscore, modified_zscore, iqr';

CREATE FUNCTION compute_outlier_scores(text, text, text DEFAULT 'zscore')
    RETURNS double precision[]
    AS 'MODULE_PATHNAME', 'compute_outlier_scores'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION compute_outlier_scores IS 'Compute outlier scores: (table, vector_col, method) returns numeric scores';

-- =============================================================================
-- PCA Whitening for Embedding Normalization
-- =============================================================================

CREATE FUNCTION whiten_embeddings(text, text, double precision DEFAULT 1e-5)
    RETURNS real[][]
    AS 'MODULE_PATHNAME', 'whiten_embeddings'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION whiten_embeddings IS 'PCA whitening: (table, vector_col, epsilon) normalizes to identity covariance';

-- =============================================================================
-- Recall@K and Search Quality Metrics
-- =============================================================================

CREATE FUNCTION recall_at_k(integer[], integer[], integer DEFAULT NULL)
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'recall_at_k'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION recall_at_k IS 'Recall@K: (retrieved_ids, relevant_ids, k) fraction of relevant items found';

CREATE FUNCTION precision_at_k(integer[], integer[], integer DEFAULT NULL)
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'precision_at_k'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION precision_at_k IS 'Precision@K: (retrieved_ids, relevant_ids, k) fraction of retrieved that are relevant';

CREATE FUNCTION f1_at_k(integer[], integer[], integer DEFAULT NULL)
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'f1_at_k'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION f1_at_k IS 'F1@K: (retrieved_ids, relevant_ids, k) harmonic mean of precision and recall';

CREATE FUNCTION mean_reciprocal_rank(integer[][], integer[][])
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'mean_reciprocal_rank'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION mean_reciprocal_rank IS 'MRR: (retrieved_lists, relevant_lists) mean reciprocal rank across queries';

-- =============================================================================
-- Drift Detection for Model Health Monitoring
-- =============================================================================

CREATE FUNCTION detect_centroid_drift(text, text, text, text)
    RETURNS RECORD
    AS 'MODULE_PATHNAME', 'detect_centroid_drift'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION detect_centroid_drift IS 'Centroid drift: (baseline_table, baseline_col, current_table, current_col) returns (distance, normalized, significant)';

CREATE FUNCTION compute_distribution_divergence(text, text, text, text)
    RETURNS double precision
    AS 'MODULE_PATHNAME', 'compute_distribution_divergence'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION compute_distribution_divergence IS 'KL divergence (approx): (baseline_table, baseline_col, current_table, current_col)';

-- =============================================================================
-- Advanced Clustering Algorithms
-- =============================================================================

CREATE FUNCTION cluster_gmm(text, text, integer, integer DEFAULT 100)
    RETURNS float8[][]
    AS 'MODULE_PATHNAME', 'cluster_gmm'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION cluster_gmm IS 'GMM (EM): (table, vector_col, k_components, max_iters) returns soft cluster assignments';

CREATE FUNCTION cluster_hierarchical(text, text, integer, text DEFAULT 'average')
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'cluster_hierarchical'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION cluster_hierarchical IS 'Hierarchical clustering: (table, vector_col, k, linkage) linkages: average, complete, single';

-- =============================================================================
-- Distance Distribution & Analytics
-- =============================================================================

CREATE FUNCTION similarity_histogram(text, text, integer DEFAULT 1000)
    RETURNS RECORD
    AS 'MODULE_PATHNAME', 'similarity_histogram'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION similarity_histogram IS 'Distance distribution: (table, vector_col, num_samples) returns (min, max, mean, stddev, p50, p90, p95, p99, samples)';

-- =============================================================================
-- Ensemble Reranking
-- =============================================================================

CREATE FUNCTION rerank_ensemble_weighted(integer[], float8[][], float8[] DEFAULT NULL, boolean DEFAULT true)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'rerank_ensemble_weighted'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION rerank_ensemble_weighted IS 'Ensemble rerank: (doc_ids, score_matrix, weights, normalize) combines multiple ranking systems';

CREATE FUNCTION rerank_ensemble_borda(integer[][])
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'rerank_ensemble_borda'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION rerank_ensemble_borda IS 'Borda count: (ranked_lists) rank-based voting ensemble';

-- =============================================================================
-- Learning to Rank (LTR)
-- =============================================================================

CREATE FUNCTION ltr_rerank_pointwise(integer[], float8[][], float8[], float8 DEFAULT 0.0)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'ltr_rerank_pointwise'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION ltr_rerank_pointwise IS 'LTR pointwise: (doc_ids, features, weights, bias) linear ranking model';

CREATE FUNCTION ltr_score_features(float8[][], float8[], float8 DEFAULT 0.0)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'ltr_score_features'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION ltr_score_features IS 'LTR scoring: (features, weights, bias) returns scores without ranking';

-- =============================================================================
-- Hybrid Search (Lexical + Semantic)
-- =============================================================================

CREATE FUNCTION hybrid_search_fusion(integer[], float8[], float8[], float8 DEFAULT 0.5, boolean DEFAULT true)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'hybrid_search_fusion'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION hybrid_search_fusion IS 'Hybrid search: (doc_ids, semantic_scores, lexical_scores, semantic_weight, normalize) combines BM25 + vector';

-- =============================================================================
-- Topic Discovery & Temporal Drift
-- =============================================================================

CREATE FUNCTION discover_topics_simple(text, text, integer DEFAULT 10, integer DEFAULT 50)
    RETURNS integer[]
    AS 'MODULE_PATHNAME', 'discover_topics_simple'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION discover_topics_simple IS 'Topic discovery: (table, vector_col, num_topics, max_iters) K-means-based topic assignment';

CREATE FUNCTION monitor_drift_timeseries(text, text, text, interval)
    RETURNS void
    AS 'MODULE_PATHNAME', 'monitor_drift_timeseries'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION monitor_drift_timeseries IS 'Temporal drift: (table, vector_col, timestamp_col, window) tracks drift over time';

-- =============================================================================
-- Optimized Product Quantization (OPQ)
-- =============================================================================

CREATE FUNCTION train_opq_rotation(text, text, integer DEFAULT 8)
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'train_opq_rotation'
    LANGUAGE C STABLE STRICT;
COMMENT ON FUNCTION train_opq_rotation IS 'OPQ rotation: (table, vector_col, num_subspaces) learns rotation matrix';

CREATE FUNCTION apply_opq_rotation(float8[], float8[])
    RETURNS float8[]
    AS 'MODULE_PATHNAME', 'apply_opq_rotation'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION apply_opq_rotation IS 'OPQ apply: (vector, rotation_matrix) rotates vector for quantization';

-- =============================================================================
-- Complex ML Algorithms (External Recommended)
-- =============================================================================

-- HNSW Graph Construction:
--   Already implemented as PostgreSQL index. Use:
--   CREATE INDEX ON table USING hnsw (vector_col vector_l2_ops);
--
-- UMAP Dimensionality Reduction:
--   Complex non-linear manifold learning. Recommended:
--   - Use Python: umap-learn library
--   - Train externally, store reduced vectors
--   - Example: df['umap'] = UMAP(n_components=2).fit_transform(df['embedding'])
--
-- Spectral Clustering:
--   Requires eigendecomposition of affinity matrix. Recommended:
--   - Use Python: sklearn.cluster.SpectralClustering
--   - For graph-based clustering on precomputed similarities
--   - Example: SpectralClustering(n_clusters=5, affinity='precomputed')
--
-- Note: These algorithms are computationally intensive and benefit from
-- optimized linear algebra libraries (BLAS/LAPACK) available in Python/R.

-- CREATE FUNCTION discover_topics(text, text, integer DEFAULT 10)
--     RETURNS TABLE(topic_id integer, keywords text, size integer)
--     AS 'MODULE_PATHNAME', 'discover_topics'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION discover_topics IS 'Topic modeling: (table, vector_col, num_topics)';

-- ============================================================================
-- UTILITY FUNCTIONS
-- ============================================================================

CREATE FUNCTION array_to_vector(real[]) RETURNS vector
    AS 'MODULE_PATHNAME', 'array_to_vector'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION array_to_vector IS 'Convert float array to vector';

CREATE FUNCTION vector_to_array(vector) RETURNS real[]
    AS 'MODULE_PATHNAME', 'vector_to_array'
    LANGUAGE C IMMUTABLE STRICT;
COMMENT ON FUNCTION vector_to_array IS 'Convert vector to float array';

-- Casts between vector and real[]
CREATE CAST (real[] AS vector)
    WITH FUNCTION array_to_vector(real[])
    AS ASSIGNMENT;

CREATE CAST (vector AS real[])
    WITH FUNCTION vector_to_array(vector)
    AS ASSIGNMENT;

-- ============================================================================
-- SUMMARY
-- ============================================================================

COMMENT ON EXTENSION neurondb IS 'NeurondB: Advanced AI Database - 100+ functions for vector search, ML inference, hybrid search, RAG, and analytics';

-- ============================================================================
-- GPU ACCELERATION SUPPORT
-- ============================================================================

-- GPU control and info functions (TODO: implement in gpu_sql.c)
-- CREATE FUNCTION neurondb_gpu_enable(enabled boolean) RETURNS boolean
--     AS 'MODULE_PATHNAME', 'neurondb_gpu_enable'
--     LANGUAGE C STRICT;
-- COMMENT ON FUNCTION neurondb_gpu_enable IS 'Enable or disable GPU acceleration dynamically';

-- CREATE FUNCTION neurondb_gpu_info() 
--     RETURNS TABLE(device_id int, name text, total_memory_mb bigint, 
--                   free_memory_mb bigint, compute_major int, compute_minor int, is_available boolean)
--     AS 'MODULE_PATHNAME', 'neurondb_gpu_info'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION neurondb_gpu_info IS 'Returns GPU device information';

-- CREATE FUNCTION neurondb_gpu_stats() 
--     RETURNS TABLE(queries_executed bigint, fallback_count bigint, 
--                   total_gpu_time_ms double precision, total_cpu_time_ms double precision,
--                   avg_latency_ms double precision, last_reset timestamptz)
--     AS 'MODULE_PATHNAME', 'neurondb_gpu_stats'
--     LANGUAGE C STABLE;
-- COMMENT ON FUNCTION neurondb_gpu_stats IS 'Returns GPU runtime statistics';

-- CREATE FUNCTION neurondb_gpu_stats_reset() RETURNS boolean
--     AS 'MODULE_PATHNAME', 'neurondb_gpu_reset_stats_func'
--     LANGUAGE C STRICT;
-- COMMENT ON FUNCTION neurondb_gpu_stats_reset IS 'Reset GPU statistics counters';

-- GPU statistics view (TODO: uncomment when stats functions are implemented)
-- CREATE VIEW pg_stat_neurondb_gpu AS
--     SELECT * FROM neurondb_gpu_stats();
-- COMMENT ON VIEW pg_stat_neurondb_gpu IS 'GPU runtime statistics and monitoring';

-- GPU distance function overrides
CREATE FUNCTION vector_l2_distance_gpu(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_l2_distance_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_l2_distance_gpu IS 'GPU-accelerated L2 distance (with CPU fallback)';

CREATE FUNCTION vector_cosine_distance_gpu(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_cosine_distance_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_cosine_distance_gpu IS 'GPU-accelerated cosine distance (with CPU fallback)';

CREATE FUNCTION vector_inner_product_gpu(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_inner_product_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_inner_product_gpu IS 'GPU-accelerated inner product (with CPU fallback)';

-- GPU ANN search functions
CREATE FUNCTION hnsw_knn_search_gpu(query vector, k int, ef_search int DEFAULT 100)
    RETURNS TABLE(id bigint, distance real)
    AS 'MODULE_PATHNAME', 'hnsw_knn_search_gpu'
    LANGUAGE C STABLE PARALLEL RESTRICTED;
COMMENT ON FUNCTION hnsw_knn_search_gpu IS 'GPU-accelerated HNSW k-NN search';

CREATE FUNCTION ivf_knn_search_gpu(query vector, k int, nprobe int DEFAULT 10)
    RETURNS TABLE(id bigint, distance real)
    AS 'MODULE_PATHNAME', 'ivf_knn_search_gpu'
    LANGUAGE C STABLE PARALLEL RESTRICTED;
COMMENT ON FUNCTION ivf_knn_search_gpu IS 'GPU-accelerated IVF k-NN search';

-- GPU quantization functions
CREATE FUNCTION vector_to_int8_gpu(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_to_int8_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_to_int8_gpu IS 'GPU-accelerated INT8 quantization';

CREATE FUNCTION vector_to_fp16_gpu(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_to_fp16_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_to_fp16_gpu IS 'GPU-accelerated FP16 quantization';

CREATE FUNCTION vector_to_binary_gpu(vector) RETURNS bytea
    AS 'MODULE_PATHNAME', 'vector_to_binary_gpu'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION vector_to_binary_gpu IS 'GPU-accelerated binary quantization';

-- GPU clustering functions (TODO: implement in gpu_clustering.c)
-- CREATE FUNCTION cluster_kmeans_gpu(table_name text, vector_col text, k int, max_iters int DEFAULT 100)
--     RETURNS TABLE(id bigint, cluster int)
--     AS 'MODULE_PATHNAME', 'cluster_kmeans_gpu'
--     LANGUAGE C STABLE PARALLEL RESTRICTED;
-- COMMENT ON FUNCTION cluster_kmeans_gpu IS 'GPU-accelerated K-means clustering';

-- ============================================================================
-- INDEX VALIDATION AND DIAGNOSTICS
-- ============================================================================

-- Validate index integrity
CREATE FUNCTION neurondb_validate(index_oid regclass)
    RETURNS TABLE(
        valid boolean,
        errors integer,
        warnings integer,
        messages text,
        validated_at timestamptz
    )
    AS 'MODULE_PATHNAME', 'neurondb_validate'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_validate IS 'Validate NeurondB index integrity (graph connectivity, dead tuples)';

-- Get index diagnostics
CREATE FUNCTION neurondb_diag(index_oid regclass)
    RETURNS TABLE(
        index_name text,
        index_type text,
        total_tuples bigint,
        dead_tuples bigint,
        orphan_nodes bigint,
        avg_connectivity real,
        fragmentation real,
        size_bytes bigint,
        health_status text
    )
    AS 'MODULE_PATHNAME', 'neurondb_diag'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_diag IS 'Get comprehensive index diagnostics and health metrics';

-- Rebuild index with optimization
CREATE FUNCTION neurondb_rebuild_index(index_oid regclass) RETURNS void
    AS 'MODULE_PATHNAME', 'neurondb_rebuild_index'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_rebuild_index IS 'Rebuild index with optimization (compaction, rebalancing)';

-- ============================================================================
-- INDEX ACCESS METHODS (HNSW, IVF)
-- ============================================================================

-- HNSW Index Access Method handler
CREATE FUNCTION hnsw_handler(internal) RETURNS index_am_handler
    AS 'MODULE_PATHNAME', 'hnsw_handler'
    LANGUAGE C STRICT;
COMMENT ON FUNCTION hnsw_handler IS 'HNSW Index Access Method handler';

-- IVF Index Access Method handler
CREATE FUNCTION ivf_handler(internal) RETURNS index_am_handler
    AS 'MODULE_PATHNAME', 'ivf_handler'
    LANGUAGE C STRICT;
COMMENT ON FUNCTION ivf_handler IS 'IVF Index Access Method handler with KMeans clustering';

-- Create HNSW access method
CREATE ACCESS METHOD hnsw TYPE INDEX HANDLER hnsw_handler;
COMMENT ON ACCESS METHOD hnsw IS 'HNSW (Hierarchical Navigable Small World) index for approximate nearest neighbor search';

-- Create IVF access method
CREATE ACCESS METHOD ivf TYPE INDEX HANDLER ivf_handler;
COMMENT ON ACCESS METHOD ivf IS 'IVF (Inverted File) index with KMeans clustering for ANN search';

-- ============================================================================
-- OPERATOR CLASSES FOR DISTANCE OPERATORS
-- ============================================================================

-- Operator class support functions
CREATE FUNCTION vector_l2_distance_op(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_l2_distance_op'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_cosine_distance_op(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_cosine_distance_op'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_inner_product_distance_op(vector, vector) RETURNS real
    AS 'MODULE_PATHNAME', 'vector_inner_product_distance_op'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

-- Operator class comparison functions
CREATE FUNCTION vector_l2_less(vector, vector, vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'vector_l2_less'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_l2_less_equal(vector, vector, vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'vector_l2_less_equal'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_l2_equal(vector, vector, vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'vector_l2_equal'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_l2_greater(vector, vector, vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'vector_l2_greater'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

CREATE FUNCTION vector_l2_greater_equal(vector, vector, vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'vector_l2_greater_equal'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;

-- Check if operator class exists
CREATE FUNCTION neurondb_has_opclass(opclass_name text) RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_has_opclass'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_has_opclass IS 'Check if NeurondB operator class exists';

-- ============================================================================
-- ROW-LEVEL SECURITY (RLS) INTEGRATION
-- ============================================================================

-- Test RLS enforcement
CREATE FUNCTION neurondb_test_rls(relation_oid regclass) RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_test_rls'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_test_rls IS 'Test if relation has RLS policies enabled';

-- Create tenant isolation policy helper
CREATE FUNCTION neurondb_create_tenant_policy(table_name text, tenant_column text) RETURNS void
    AS 'MODULE_PATHNAME', 'neurondb_create_tenant_policy'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_create_tenant_policy IS 'Helper to create tenant isolation RLS policy';

-- ============================================================================
-- QUOTA MANAGEMENT
-- ============================================================================

-- Quota tracking table
CREATE TABLE IF NOT EXISTS neurondb.tenant_usage (
    tenant_id text NOT NULL,
    index_oid oid NOT NULL,
    vector_count bigint DEFAULT 0,
    storage_bytes bigint DEFAULT 0,
    last_updated timestamptz DEFAULT now(),
    PRIMARY KEY (tenant_id, index_oid)
);
COMMENT ON TABLE neurondb.tenant_usage IS 'Per-tenant resource usage tracking';

-- Check quota
CREATE FUNCTION neurondb_check_quota(tenant_id text, index_oid oid, additional_vectors bigint) RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_check_quota'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_check_quota IS 'Check if operation would exceed tenant quota';

-- Get quota usage
CREATE FUNCTION neurondb_get_quota_usage(tenant_id text, index_oid oid)
    RETURNS TABLE(
        vector_count bigint,
        max_vectors bigint,
        storage_bytes bigint,
        max_storage bigint,
        current_qps integer,
        max_qps integer
    )
    AS 'MODULE_PATHNAME', 'neurondb_get_quota_usage'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_get_quota_usage IS 'Get current quota usage and limits for tenant';

-- Reset quota (for testing)
CREATE FUNCTION neurondb_reset_quota(tenant_id text) RETURNS void
    AS 'MODULE_PATHNAME', 'neurondb_reset_quota'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_reset_quota IS 'Reset quota tracking for tenant (testing only)';

-- ============================================================================
-- TENANT QUOTAS TABLE (for quota enforcement)
-- ============================================================================

CREATE TABLE IF NOT EXISTS neurondb.tenant_quotas (
    tenant_id text PRIMARY KEY,
    max_vectors bigint DEFAULT 1000000,
    max_storage_mb bigint DEFAULT 10000,
    max_qps bigint DEFAULT 1000,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now()
);
COMMENT ON TABLE neurondb.tenant_quotas IS 'Per-tenant resource quota limits';

-- ============================================================================
-- ROW-LEVEL SECURITY POLICIES TABLE
-- ============================================================================

CREATE TABLE IF NOT EXISTS neurondb.rls_policies (
    policy_id serial PRIMARY KEY,
    table_name text NOT NULL,
    policy_name text NOT NULL,
    policy_expression text NOT NULL,
    role_name text,
    enabled boolean DEFAULT true,
    created_at timestamptz DEFAULT now(),
    UNIQUE(table_name, policy_name)
);
COMMENT ON TABLE neurondb.rls_policies IS 'Row-level security policy definitions for vector tables';

-- ============================================================================
-- INDEX METADATA TABLE (for validation and health tracking)
-- ============================================================================

CREATE TABLE IF NOT EXISTS neurondb.index_metadata (
    index_oid oid PRIMARY KEY,
    index_type text NOT NULL,  -- 'hnsw', 'ivf', etc.
    parameters jsonb,
    stats jsonb,
    last_validated timestamptz,
    health_status text DEFAULT 'unknown',
    validation_errors text[]
);
COMMENT ON TABLE neurondb.index_metadata IS 'Index metadata, validation status, and health tracking';

-- ============================================================================
-- HNSW ENTRYPOINT CACHE
-- ============================================================================

-- Clear entrypoint cache
CREATE FUNCTION neurondb_clear_entrypoint_cache() RETURNS void
    AS 'MODULE_PATHNAME', 'neurondb_clear_entrypoint_cache'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_clear_entrypoint_cache IS 'Clear HNSW entrypoint cache (LRU)';

-- Get cache statistics
CREATE FUNCTION neurondb_entrypoint_cache_stats()
    RETURNS TABLE(
        max_entries integer,
        current_entries integer,
        valid_entries integer
    )
    AS 'MODULE_PATHNAME', 'neurondb_entrypoint_cache_stats'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_entrypoint_cache_stats IS 'Get HNSW entrypoint cache statistics';

-- ============================================================================
-- TEMPORAL SCORING
-- ============================================================================

-- Compute temporal hybrid score
CREATE FUNCTION neurondb_temporal_score(
    vector_distance real,
    doc_timestamp timestamptz,
    decay_rate real,
    recency_weight real
) RETURNS real
    AS 'MODULE_PATHNAME', 'neurondb_temporal_score'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION neurondb_temporal_score IS 'Compute hybrid score with exponential time decay';

-- Temporal window filter
CREATE FUNCTION neurondb_temporal_filter(doc_timestamp timestamptz, time_window interval) RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_temporal_filter'
    LANGUAGE C IMMUTABLE STRICT PARALLEL SAFE;
COMMENT ON FUNCTION neurondb_temporal_filter IS 'Check if document is within time window';

-- ============================================================================
-- PROMETHEUS METRICS
-- ============================================================================

-- Get Prometheus metrics
CREATE FUNCTION neurondb_prometheus_metrics()
    RETURNS TABLE(
        queries_total bigint,
        queries_success bigint,
        queries_error bigint,
        query_duration_sum double precision,
        vectors_total bigint,
        cache_hits bigint,
        cache_misses bigint,
        workers_active integer
    )
    AS 'MODULE_PATHNAME', 'neurondb_prometheus_metrics'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_prometheus_metrics IS 'Get Prometheus-compatible metrics (also available via HTTP on port 9187)';

-- ============================================================================
-- BACKGROUND WORKER MANUAL TRIGGERS
-- ============================================================================

-- Manually run queue worker once
CREATE FUNCTION neuranq_run_once() RETURNS void
    AS 'MODULE_PATHNAME', 'neuranq_run_once'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neuranq_run_once IS 'Manually trigger neuranq worker execution (for testing)';

-- Manually run defrag worker
CREATE FUNCTION neurandefrag_run(index_oid regclass) RETURNS void
    AS 'MODULE_PATHNAME', 'neurandefrag_run'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurandefrag_run IS 'Manually trigger index defragmentation';

-- Manually run tuner sample
CREATE FUNCTION neuranmon_sample() RETURNS void
    AS 'MODULE_PATHNAME', 'neuranmon_sample'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neuranmon_sample IS 'Manually trigger tuner sampling';

-- ============================================================================
-- WORKER CATALOG TABLES
-- ============================================================================

-- Queue worker job table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_job_queue (
    job_id bigserial PRIMARY KEY,
    tenant_id integer DEFAULT 0,
    job_type text NOT NULL,
    payload jsonb NOT NULL,
    status text DEFAULT 'pending',
    retry_count integer DEFAULT 0,
    max_retries integer DEFAULT 3,
    backoff_until timestamptz,
    error_message text,
    created_at timestamptz DEFAULT now(),
    started_at timestamptz,
    completed_at timestamptz
);
COMMENT ON TABLE neurondb.neurondb_job_queue IS 'Background job queue processed by neuranq worker';

CREATE INDEX IF NOT EXISTS idx_job_queue_status ON neurondb.neurondb_job_queue(status, created_at);
CREATE INDEX IF NOT EXISTS idx_job_queue_tenant ON neurondb.neurondb_job_queue(tenant_id, created_at);

-- Query metrics table for tuner
CREATE TABLE IF NOT EXISTS neurondb.neurondb_query_metrics (
    metric_id bigserial PRIMARY KEY,
    query_hash text,
    query_type text,
    latency_ms real,
    recall_at_k real,
    query_timestamp timestamptz DEFAULT now(),
    index_name text,
    ef_search integer,
    hybrid_weight real
);
COMMENT ON TABLE neurondb.neurondb_query_metrics IS 'Query performance metrics for auto-tuning';

CREATE INDEX IF NOT EXISTS idx_query_metrics_timestamp ON neurondb.neurondb_query_metrics(query_timestamp);
CREATE INDEX IF NOT EXISTS idx_query_metrics_hash ON neurondb.neurondb_query_metrics(query_hash);

-- Index maintenance metadata for defrag worker
CREATE TABLE IF NOT EXISTS neurondb.neurondb_index_maintenance (
    index_name text PRIMARY KEY,
    index_type text,
    num_nodes bigint DEFAULT 0,
    num_edges bigint DEFAULT 0,
    num_tombstones bigint DEFAULT 0,
    fragmentation_ratio real DEFAULT 0.0,
    last_compaction timestamptz,
    last_rebuild timestamptz,
    last_stats_refresh timestamptz DEFAULT now()
);
COMMENT ON TABLE neurondb.neurondb_index_maintenance IS 'Index maintenance metadata for neurandefrag worker';

-- Embedding cache table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_embedding_cache (
    cache_key text PRIMARY KEY,
    model_name text NOT NULL,
    embedding vector,
    created_at timestamptz DEFAULT now(),
    last_accessed timestamptz DEFAULT now(),
    access_count bigint DEFAULT 1
);
COMMENT ON TABLE neurondb.neurondb_embedding_cache IS 'Cached embeddings for performance';

CREATE INDEX IF NOT EXISTS idx_embedding_cache_accessed ON neurondb.neurondb_embedding_cache(last_accessed);
CREATE INDEX IF NOT EXISTS idx_embedding_cache_model ON neurondb.neurondb_embedding_cache(model_name);

-- Histogram table for metrics distribution
CREATE TABLE IF NOT EXISTS neurondb.neurondb_histograms (
    metric_name text NOT NULL,
    bucket_start real NOT NULL,
    bucket_end real NOT NULL,
    count bigint DEFAULT 0,
    last_updated timestamptz DEFAULT now(),
    PRIMARY KEY (metric_name, bucket_start)
);
COMMENT ON TABLE neurondb.neurondb_histograms IS 'Performance metric histograms for monitoring';

CREATE INDEX IF NOT EXISTS idx_histograms_metric ON neurondb.neurondb_histograms(metric_name, last_updated);

-- Prometheus metrics staging table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_prometheus_metrics (
    metric_name text PRIMARY KEY,
    metric_value real NOT NULL,
    last_updated timestamptz DEFAULT now()
);
COMMENT ON TABLE neurondb.neurondb_prometheus_metrics IS 'Staging table for Prometheus metrics export';

-- ============================================================================
-- LLM / HUGGING FACE INTEGRATION (Extended)
-- ============================================================================

-- LLM cache table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_llm_cache (
    cache_key text PRIMARY KEY,
    model_name text NOT NULL,
    operation text NOT NULL,
    request_hash text NOT NULL,
    response_text text,
    response_vector vector,
    created_at timestamptz DEFAULT now(),
    accessed_at timestamptz DEFAULT now(),
    access_count bigint DEFAULT 1
);
COMMENT ON TABLE neurondb.neurondb_llm_cache IS 'LLM response cache with automatic expiration';

CREATE INDEX IF NOT EXISTS idx_llm_cache_model ON neurondb.neurondb_llm_cache(model_name, created_at);
CREATE INDEX IF NOT EXISTS idx_llm_cache_accessed ON neurondb.neurondb_llm_cache(accessed_at);

-- LLM job queue table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_llm_jobs (
    job_id bigserial PRIMARY KEY,
    tenant_id text,
    operation text NOT NULL,
    model_name text NOT NULL,
    input_text text,
    input_vector vector,
    status text DEFAULT 'pending',
    result_text text,
    result_vector vector,
    error_message text,
    created_at timestamptz DEFAULT now(),
    started_at timestamptz,
    completed_at timestamptz,
    retry_count integer DEFAULT 0
);
COMMENT ON TABLE neurondb.neurondb_llm_jobs IS 'Asynchronous LLM job queue processed by neuranllm worker';

CREATE INDEX IF NOT EXISTS idx_llm_jobs_status ON neurondb.neurondb_llm_jobs(status, created_at);
CREATE INDEX IF NOT EXISTS idx_llm_jobs_tenant ON neurondb.neurondb_llm_jobs(tenant_id, created_at);

-- ============================================================================
-- ML PROJECT MANAGEMENT SYSTEM
-- ============================================================================
-- Provides organized model lifecycle management with versioning,
-- experiment tracking, and model deployment capabilities.
-- Inspired by PostgresML's project concept.
-- ============================================================================

-- ML Model Type Enum
DO $$ BEGIN
    CREATE TYPE neurondb.ml_model_type AS ENUM (
        'clustering',
        'classification',
        'regression',
        'dimensionality_reduction',
        'outlier_detection',
        'embedding'
    );
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

-- ML Algorithm Type Enum
DO $$ BEGIN
    CREATE TYPE neurondb.ml_algorithm_type AS ENUM (
        'kmeans',
        'dbscan',
        'gmm',
        'hierarchical',
        'minibatch_kmeans',
        'pca',
        'isolation_forest',
        'custom'
    );
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

-- ML Model Status Enum
DO $$ BEGIN
    CREATE TYPE neurondb.ml_model_status AS ENUM (
        'training',
        'completed',
        'failed',
        'deployed'
    );
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$;

-- Projects: Top-level organization for ML work
CREATE TABLE IF NOT EXISTS neurondb.ml_projects (
    project_id serial PRIMARY KEY,
    project_name text UNIQUE NOT NULL,
    model_type neurondb.ml_model_type NOT NULL,
    description text,
    created_at timestamptz DEFAULT now(),
    updated_at timestamptz DEFAULT now(),
    created_by text DEFAULT CURRENT_USER,
    metadata jsonb DEFAULT '{}'::jsonb,
    
    CONSTRAINT valid_project_name CHECK (LENGTH(project_name) >= 3 AND LENGTH(project_name) <= 100)
);
COMMENT ON TABLE neurondb.ml_projects IS 'ML project organization and metadata';

-- Models: Trained models with versioning
CREATE TABLE IF NOT EXISTS neurondb.ml_models (
    model_id serial PRIMARY KEY,
    project_id integer NOT NULL REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    version integer NOT NULL,
    algorithm neurondb.ml_algorithm_type NOT NULL,
    status neurondb.ml_model_status DEFAULT 'training',
    
    -- Training configuration
    training_table text NOT NULL,
    training_column text NOT NULL,
    parameters jsonb DEFAULT '{}'::jsonb,
    
    -- Model artifacts
    model_data bytea,
    
    -- Metrics and evaluation
    metrics jsonb DEFAULT '{}'::jsonb,
    training_time_ms integer,
    num_samples integer,
    num_features integer,
    
    -- Deployment
    is_deployed boolean DEFAULT false,
    deployed_at timestamptz,
    
    -- Timestamps
    created_at timestamptz DEFAULT now(),
    completed_at timestamptz,
    
    notes text,
    
    CONSTRAINT unique_project_version UNIQUE(project_id, version),
    CONSTRAINT positive_version CHECK (version > 0)
);
COMMENT ON TABLE neurondb.ml_models IS 'Trained models with versioning and metrics';

-- Experiments: Track training runs and comparisons
CREATE TABLE IF NOT EXISTS neurondb.ml_experiments (
    experiment_id serial PRIMARY KEY,
    project_id integer NOT NULL REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    model_id integer REFERENCES neurondb.ml_models(model_id) ON DELETE CASCADE,
    experiment_name text,
    status neurondb.ml_model_status DEFAULT 'training',
    config jsonb DEFAULT '{}'::jsonb,
    metrics jsonb DEFAULT '{}'::jsonb,
    logs text,
    started_at timestamptz DEFAULT now(),
    completed_at timestamptz,
    notes text
);
COMMENT ON TABLE neurondb.ml_experiments IS 'Experiment tracking and comparison';

-- Indexes for ML project management
CREATE INDEX IF NOT EXISTS idx_ml_projects_name ON neurondb.ml_projects(project_name);
CREATE INDEX IF NOT EXISTS idx_ml_projects_type ON neurondb.ml_projects(model_type);
CREATE INDEX IF NOT EXISTS idx_ml_models_project ON neurondb.ml_models(project_id);
CREATE INDEX IF NOT EXISTS idx_ml_models_deployed ON neurondb.ml_models(is_deployed) WHERE is_deployed = true;
CREATE INDEX IF NOT EXISTS idx_ml_models_status ON neurondb.ml_models(status);
CREATE INDEX IF NOT EXISTS idx_ml_experiments_project ON neurondb.ml_experiments(project_id);

-- Views for project management
CREATE OR REPLACE VIEW neurondb.ml_projects_summary AS
SELECT 
    p.project_id,
    p.project_name,
    p.model_type,
    p.description,
    p.created_at,
    p.updated_at,
    COUNT(DISTINCT m.model_id) as total_models,
    MAX(m.version) as latest_version,
    MAX(CASE WHEN m.is_deployed THEN m.version END) as deployed_version,
    MAX(m.metrics->>'silhouette_score') as best_silhouette_score
FROM neurondb.ml_projects p
LEFT JOIN neurondb.ml_models m ON p.project_id = m.project_id
GROUP BY p.project_id, p.project_name, p.model_type, p.description, p.created_at, p.updated_at;

COMMENT ON VIEW neurondb.ml_projects_summary IS 'Summary view of all projects with model counts';

CREATE OR REPLACE VIEW neurondb.ml_model_comparison AS
SELECT 
    p.project_name,
    m.model_id,
    m.version,
    m.algorithm,
    m.status,
    m.is_deployed,
    m.parameters,
    m.metrics,
    m.training_time_ms,
    m.num_samples,
    m.created_at,
    m.completed_at
FROM neurondb.ml_models m
JOIN neurondb.ml_projects p ON m.project_id = p.project_id
ORDER BY p.project_name, m.version DESC;

COMMENT ON VIEW neurondb.ml_model_comparison IS 'Compare model performance across versions';

CREATE OR REPLACE VIEW neurondb.ml_deployment_status AS
SELECT 
    p.project_name,
    p.model_type,
    m.model_id,
    m.version,
    m.algorithm,
    m.parameters,
    m.deployed_at,
    m.metrics,
    AGE(NOW(), m.deployed_at) as deployment_age
FROM neurondb.ml_projects p
JOIN neurondb.ml_models m ON p.project_id = m.project_id
WHERE m.is_deployed = true;

COMMENT ON VIEW neurondb.ml_deployment_status IS 'Currently deployed models';

-- Trigger to update project timestamp
CREATE OR REPLACE FUNCTION neurondb.update_project_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE neurondb.ml_projects 
    SET updated_at = NOW() 
    WHERE project_id = NEW.project_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trigger_update_project_timestamp ON neurondb.ml_models;
CREATE TRIGGER trigger_update_project_timestamp
    AFTER INSERT OR UPDATE ON neurondb.ml_models
    FOR EACH ROW
    EXECUTE FUNCTION neurondb.update_project_timestamp();

-- LLM statistics table
CREATE TABLE IF NOT EXISTS neurondb.neurondb_llm_stats (
    model_name text PRIMARY KEY,
    total_requests bigint DEFAULT 0,
    successful_requests bigint DEFAULT 0,
    failed_requests bigint DEFAULT 0,
    cache_hits bigint DEFAULT 0,
    total_latency_ms bigint DEFAULT 0,
    total_tokens bigint DEFAULT 0,
    last_request_at timestamptz,
    last_updated timestamptz DEFAULT now()
);
COMMENT ON TABLE neurondb.neurondb_llm_stats IS 'LLM usage statistics per model';

-- C-backed LLM functions
CREATE FUNCTION ndb_llm_complete(prompt text, model text, max_tokens integer, temperature real) RETURNS text
    AS 'MODULE_PATHNAME', 'ndb_llm_complete'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION ndb_llm_complete IS 'Direct LLM completion via C extension';

CREATE FUNCTION ndb_llm_embed(text_input text, model text) RETURNS vector
    AS 'MODULE_PATHNAME', 'ndb_llm_embed'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION ndb_llm_embed IS 'Direct LLM embedding via C extension';

CREATE FUNCTION ndb_llm_rerank(query text, documents text[], model text, top_k integer) RETURNS TABLE(idx integer, score real)
    AS 'MODULE_PATHNAME', 'ndb_llm_rerank'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION ndb_llm_rerank IS 'LLM-based reranking via C extension';

CREATE FUNCTION ndb_llm_enqueue(operation text, model text, input_text text, tenant_id text) RETURNS bigint
    AS 'MODULE_PATHNAME', 'ndb_llm_enqueue'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION ndb_llm_enqueue IS 'Enqueue asynchronous LLM job';

-- ============================================================================
-- DISTRIBUTED QUERY FUNCTIONS
-- ============================================================================

CREATE FUNCTION distributed_knn_search(
    query vector,
    k integer,
    replicas text[],
    merge_strategy text DEFAULT 'balanced'
) RETURNS TABLE(id bigint, distance real, node text)
    AS 'MODULE_PATHNAME', 'distributed_knn_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION distributed_knn_search IS 'Distributed k-NN search across replicas';

CREATE FUNCTION merge_distributed_results(
    results jsonb,
    k integer,
    strategy text DEFAULT 'min_distance'
) RETURNS TABLE(id bigint, distance real, source_node text)
    AS 'MODULE_PATHNAME', 'merge_distributed_results'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION merge_distributed_results IS 'Merge results from distributed search';

CREATE FUNCTION select_optimal_replica(
    query_hash text,
    replicas text[],
    strategy text DEFAULT 'latency'
) RETURNS text
    AS 'MODULE_PATHNAME', 'select_optimal_replica'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION select_optimal_replica IS 'Select optimal replica for query routing';

CREATE FUNCTION sync_index_async(
    source_index regclass,
    target_connection text,
    batch_size integer DEFAULT 1000
) RETURNS bigint
    AS 'MODULE_PATHNAME', 'sync_index_async'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION sync_index_async IS 'Asynchronously sync index to remote node';

-- ============================================================================
-- DATA MANAGEMENT FUNCTIONS
-- ============================================================================

CREATE FUNCTION vector_time_travel(
    table_name text,
    vector_col text,
    timestamp_point timestamptz
) RETURNS TABLE(id bigint, vector_snapshot vector)
    AS 'MODULE_PATHNAME', 'vector_time_travel'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION vector_time_travel IS 'Time-travel query for vector data';

CREATE FUNCTION compress_cold_tier(
    table_name text,
    vector_col text,
    age_threshold interval,
    compression_method text DEFAULT 'int8'
) RETURNS bigint
    AS 'MODULE_PATHNAME', 'compress_cold_tier'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION compress_cold_tier IS 'Compress vectors in cold tier storage';

CREATE FUNCTION vacuum_vectors(
    table_name text,
    aggressive boolean DEFAULT false
) RETURNS TABLE(reclaimed_bytes bigint, duration_ms bigint)
    AS 'MODULE_PATHNAME', 'vacuum_vectors'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION vacuum_vectors IS 'Vacuum vector table with index maintenance';

CREATE FUNCTION rebalance_index(
    index_name regclass,
    target_balance_ratio real DEFAULT 0.9
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'rebalance_index'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION rebalance_index IS 'Rebalance index for optimal performance';

-- ============================================================================
-- PLANNER AND OPTIMIZATION
-- ============================================================================

CREATE FUNCTION auto_route_query(
    query_text text,
    context jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'auto_route_query'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION auto_route_query IS 'Automatically route query to optimal execution path';

CREATE FUNCTION learn_from_query(
    query_plan text,
    actual_cost real,
    estimated_cost real
) RETURNS void
    AS 'MODULE_PATHNAME', 'learn_from_query'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION learn_from_query IS 'Learn from query execution for cost model tuning';

CREATE FUNCTION scale_precision(
    workload_type text,
    target_latency_ms real
) RETURNS text
    AS 'MODULE_PATHNAME', 'scale_precision'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION scale_precision IS 'Scale precision based on workload and latency requirements';

CREATE FUNCTION prefetch_entry_points(
    index_name regclass,
    query_patterns text[]
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'prefetch_entry_points'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION prefetch_entry_points IS 'Prefetch HNSW entry points based on query patterns';

-- ============================================================================
-- STORAGE AND BUFFER MANAGEMENT
-- ============================================================================

CREATE FUNCTION rebuild_hnsw_safe(
    index_name regclass,
    checkpoint_interval integer DEFAULT 10000
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'rebuild_hnsw_safe'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION rebuild_hnsw_safe IS 'Safely rebuild HNSW index with checkpointing';

CREATE FUNCTION parallel_knn_search(
    query vector,
    k integer,
    parallel_degree integer DEFAULT 4
) RETURNS TABLE(id bigint, distance real)
    AS 'MODULE_PATHNAME', 'parallel_knn_search'
    LANGUAGE C STABLE PARALLEL SAFE;
COMMENT ON FUNCTION parallel_knn_search IS 'Parallel k-NN search with work distribution';

CREATE FUNCTION save_rebuild_checkpoint(
    index_name regclass,
    checkpoint_data bytea
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'save_rebuild_checkpoint'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION save_rebuild_checkpoint IS 'Save checkpoint during index rebuild';

CREATE FUNCTION load_rebuild_checkpoint(
    index_name regclass
) RETURNS bytea
    AS 'MODULE_PATHNAME', 'load_rebuild_checkpoint'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION load_rebuild_checkpoint IS 'Load checkpoint for index rebuild recovery';

-- ============================================================================
-- ANN BUFFER MANAGEMENT
-- ============================================================================

CREATE FUNCTION neurondb_ann_buffer_get_centroid(centroid_id integer) RETURNS vector
    AS 'MODULE_PATHNAME', 'neurondb_ann_buffer_get_centroid'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_ann_buffer_get_centroid IS 'Get centroid from in-memory ANN buffer';

CREATE FUNCTION neurondb_ann_buffer_put_centroid(centroid_id integer, centroid vector) RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_ann_buffer_put_centroid'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_ann_buffer_put_centroid IS 'Store centroid in in-memory ANN buffer';

CREATE FUNCTION neurondb_ann_buffer_get_stats()
    RETURNS TABLE(
        total_entries integer,
        memory_used_bytes bigint,
        hit_rate real,
        evictions bigint
    )
    AS 'MODULE_PATHNAME', 'neurondb_ann_buffer_get_stats'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION neurondb_ann_buffer_get_stats IS 'Get ANN buffer cache statistics';

CREATE FUNCTION neurondb_ann_buffer_clear() RETURNS boolean
    AS 'MODULE_PATHNAME', 'neurondb_ann_buffer_clear'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION neurondb_ann_buffer_clear IS 'Clear ANN buffer cache';

-- ============================================================================
-- UTILITY VIEWS (neurondb schema)
-- ============================================================================

-- View: Combined vector statistics across all indexes
CREATE VIEW neurondb.vector_stats AS
SELECT 
    'Total Vectors' as metric,
    COALESCE(SUM(vector_count), 0) as value,
    'vectors' as unit
FROM neurondb.tenant_usage
UNION ALL
SELECT 
    'Total Storage',
    COALESCE(SUM(storage_bytes) / 1024.0 / 1024.0, 0),
    'MB'
FROM neurondb.tenant_usage
UNION ALL
SELECT 
    'Active Tenants',
    COUNT(DISTINCT tenant_id)::bigint,
    'tenants'
FROM neurondb.tenant_usage
WHERE vector_count > 0;

COMMENT ON VIEW neurondb.vector_stats IS 'Aggregate statistics across all vector indexes';

-- View: Index health monitoring
CREATE VIEW neurondb.index_health AS
SELECT 
    im.index_oid::regclass::text as index_name,
    im.index_type,
    im.health_status,
    im.last_validated,
    array_length(im.validation_errors, 1) as error_count,
    CASE 
        WHEN im.health_status = 'healthy' THEN ''
        WHEN im.health_status = 'degraded' THEN ''
        WHEN im.health_status = 'critical' THEN ''
        ELSE ''
    END as status_icon
FROM neurondb.index_metadata im
ORDER BY 
    CASE im.health_status
        WHEN 'critical' THEN 1
        WHEN 'degraded' THEN 2
        WHEN 'healthy' THEN 3
        ELSE 4
    END,
    im.last_validated DESC NULLS LAST;

COMMENT ON VIEW neurondb.index_health IS 'Index health status dashboard';

-- View: Tenant quota usage with percentages
CREATE VIEW neurondb.tenant_quota_usage AS
SELECT 
    tu.tenant_id,
    tu.vector_count,
    tq.max_vectors,
    ROUND(100.0 * tu.vector_count / NULLIF(tq.max_vectors, 0), 2) as vectors_pct,
    ROUND(tu.storage_bytes / 1024.0 / 1024.0, 2) as storage_mb,
    tq.max_storage_mb,
    ROUND(100.0 * (tu.storage_bytes / 1024.0 / 1024.0) / NULLIF(tq.max_storage_mb, 0), 2) as storage_pct,
    tq.max_qps,
    CASE 
        WHEN tu.vector_count >= tq.max_vectors * 0.9 THEN 'WARNING: Near vector limit'
        WHEN (tu.storage_bytes / 1024.0 / 1024.0) >= tq.max_storage_mb * 0.9 THEN 'WARNING: Near storage limit'
        ELSE 'OK'
    END as status
FROM neurondb.tenant_usage tu
LEFT JOIN neurondb.tenant_quotas tq ON tu.tenant_id = tq.tenant_id
ORDER BY vectors_pct DESC NULLS LAST;

COMMENT ON VIEW neurondb.tenant_quota_usage IS 'Tenant quota usage with warnings';

-- View: LLM job status summary
CREATE VIEW neurondb.llm_job_status AS
SELECT 
    status,
    COUNT(*) as job_count,
    COUNT(*) FILTER (WHERE operation = 'embed') as embed_jobs,
    COUNT(*) FILTER (WHERE operation = 'complete') as completion_jobs,
    MIN(created_at) as oldest_job,
    MAX(completed_at) as latest_update
FROM neurondb.neurondb_llm_jobs
GROUP BY status
ORDER BY 
    CASE status
        WHEN 'failed' THEN 1
        WHEN 'processing' THEN 2
        WHEN 'queued' THEN 3
        WHEN 'done' THEN 4
        ELSE 5
    END;

COMMENT ON VIEW neurondb.llm_job_status IS 'LLM job queue status summary';

-- View: Query performance metrics
CREATE VIEW neurondb.query_performance AS
SELECT 
    query_type,
    COUNT(*) as total_queries,
    ROUND(AVG(latency_ms)::numeric, 2) as avg_time_ms,
    ROUND(MIN(latency_ms)::numeric, 2) as min_time_ms,
    ROUND(MAX(latency_ms)::numeric, 2) as max_time_ms,
    ROUND(PERCENTILE_CONT(0.95) WITHIN GROUP (ORDER BY latency_ms)::numeric, 2) as p95_time_ms,
    ROUND(AVG(recall_at_k)::numeric, 3) as avg_recall
FROM neurondb.neurondb_query_metrics
WHERE query_timestamp > NOW() - INTERVAL '24 hours'
GROUP BY query_type
ORDER BY total_queries DESC;

COMMENT ON VIEW neurondb.query_performance IS 'Query performance metrics (last 24h)';

-- View: Index maintenance status
CREATE VIEW neurondb.index_maintenance_status AS
SELECT 
    index_name,
    index_type,
    num_nodes,
    num_edges,
    num_tombstones,
    fragmentation_ratio,
    last_compaction,
    last_rebuild,
    last_stats_refresh,
    CASE 
        WHEN last_rebuild IS NOT NULL THEN 
            EXTRACT(EPOCH FROM (NOW() - last_rebuild))::integer
        ELSE NULL
    END as seconds_since_rebuild
FROM neurondb.neurondb_index_maintenance
WHERE last_stats_refresh > NOW() - INTERVAL '7 days'
ORDER BY last_stats_refresh DESC
LIMIT 100;

COMMENT ON VIEW neurondb.index_maintenance_status IS 'Recent index maintenance operations';

-- View: Prometheus metrics summary
CREATE VIEW neurondb.metrics_summary AS
SELECT 
    metric_name,
    metric_value,
    last_updated,
    EXTRACT(EPOCH FROM (NOW() - last_updated))::integer as seconds_stale
FROM neurondb.neurondb_prometheus_metrics
WHERE last_updated > NOW() - INTERVAL '1 hour'
ORDER BY metric_name, last_updated DESC;

COMMENT ON VIEW neurondb.metrics_summary IS 'Recent Prometheus metrics';

-- ============================================================================
-- HIGH-PRIORITY MISSING FUNCTIONS
-- ============================================================================

-- Tenant-aware HNSW functions
CREATE FUNCTION hnsw_tenant_create(
    table_name text,
    column_name text,
    tenant_column text,
    ef_construction integer DEFAULT 200,
    m integer DEFAULT 16
) RETURNS text
    AS 'MODULE_PATHNAME', 'hnsw_tenant_create'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION hnsw_tenant_create IS 'Create tenant-aware HNSW index';

CREATE FUNCTION hnsw_tenant_search(
    table_name text,
    query_vector vector,
    k integer,
    tenant_id text
) RETURNS TABLE(id bigint, distance real)
    AS 'MODULE_PATHNAME', 'hnsw_tenant_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION hnsw_tenant_search IS 'Search tenant-aware HNSW index';

CREATE FUNCTION hnsw_tenant_quota(
    tenant_id text
) RETURNS TABLE(
    vectors_used bigint,
    vectors_limit bigint,
    storage_mb real,
    storage_limit_mb bigint
)
    AS 'MODULE_PATHNAME', 'hnsw_tenant_quota'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION hnsw_tenant_quota IS 'Get tenant quota usage for HNSW indexes';

-- Hybrid index functions
CREATE FUNCTION hybrid_index_create(
    table_name text,
    vector_column text,
    text_column text,
    options jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'hybrid_index_create'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION hybrid_index_create IS 'Create hybrid vector+FTS index';

CREATE FUNCTION hybrid_index_search(
    index_name text,
    query_vector vector,
    query_text text,
    k integer DEFAULT 10,
    alpha real DEFAULT 0.5
) RETURNS TABLE(id bigint, score real)
    AS 'MODULE_PATHNAME', 'hybrid_index_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION hybrid_index_search IS 'Search hybrid index with vector and text query';

-- Temporal index functions
CREATE FUNCTION temporal_index_create(
    table_name text,
    vector_column text,
    timestamp_column text
) RETURNS text
    AS 'MODULE_PATHNAME', 'temporal_index_create'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION temporal_index_create IS 'Create temporal-aware vector index';

CREATE FUNCTION temporal_knn_search(
    index_name text,
    query_vector vector,
    k integer,
    time_filter tstzrange DEFAULT NULL
) RETURNS TABLE(id bigint, distance real, result_timestamp timestamptz)
    AS 'MODULE_PATHNAME', 'temporal_knn_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION temporal_knn_search IS 'Time-aware k-NN search';

CREATE FUNCTION temporal_score(
    distance real,
    timestamp_val timestamptz,
    decay_rate real DEFAULT 0.1
) RETURNS real
    AS 'MODULE_PATHNAME', 'temporal_score'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION temporal_score IS 'Compute temporal-weighted score';

-- Consistency index functions
CREATE FUNCTION consistent_index_create(
    table_name text,
    vector_column text
) RETURNS text
    AS 'MODULE_PATHNAME', 'consistent_index_create'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION consistent_index_create IS 'Create eventually-consistent distributed vector index';

CREATE FUNCTION consistent_knn_search(
    index_name text,
    query_vector vector,
    k integer,
    consistency_level text DEFAULT 'eventual'
) RETURNS TABLE(id bigint, distance real)
    AS 'MODULE_PATHNAME', 'consistent_knn_search'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION consistent_knn_search IS 'Search with configurable consistency guarantees';

-- Rerank index functions
CREATE FUNCTION rerank_index_create(
    base_index_name text,
    rerank_model text DEFAULT 'cross-encoder/ms-marco-MiniLM-L-6-v2'
) RETURNS text
    AS 'MODULE_PATHNAME', 'rerank_index_create'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION rerank_index_create IS 'Create reranking cache index';

CREATE FUNCTION rerank_get_candidates(
    base_index_name text,
    query_vector vector,
    k integer,
    fetch_factor integer DEFAULT 10
) RETURNS TABLE(id bigint, distance real, cached_score real)
    AS 'MODULE_PATHNAME', 'rerank_get_candidates'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION rerank_get_candidates IS 'Get candidates from base index for reranking';

CREATE FUNCTION rerank_index_warm(
    index_name text,
    sample_queries vector[],
    top_k integer DEFAULT 100
) RETURNS integer
    AS 'MODULE_PATHNAME', 'rerank_index_warm'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION rerank_index_warm IS 'Warm up reranking cache with sample queries';

-- Configuration functions
CREATE FUNCTION get_vector_config(
    parameter_name text DEFAULT NULL
) RETURNS TABLE(name text, value text, description text)
    AS 'MODULE_PATHNAME', 'get_vector_config'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION get_vector_config IS 'Get vector configuration parameters';

CREATE FUNCTION set_vector_config(
    parameter_name text,
    parameter_value text
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'set_vector_config'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION set_vector_config IS 'Set vector configuration parameter';

CREATE FUNCTION show_vector_config() RETURNS TABLE(name text, value text)
    AS 'MODULE_PATHNAME', 'show_vector_config'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION show_vector_config IS 'Show all vector configuration';

CREATE FUNCTION reset_vector_config() RETURNS void
    AS 'MODULE_PATHNAME', 'reset_vector_config'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION reset_vector_config IS 'Reset all vector configuration to defaults';

-- Model management functions
CREATE FUNCTION mdl_http(
    endpoint text,
    payload jsonb
) RETURNS jsonb
    AS 'MODULE_PATHNAME', 'mdl_http'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION mdl_http IS 'Send HTTP request to model endpoint';

CREATE FUNCTION mdl_llm(
    model_name text,
    prompt text,
    options jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'mdl_llm'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION mdl_llm IS 'Call LLM model endpoint';

CREATE FUNCTION mdl_cache(
    operation text,
    key text DEFAULT NULL,
    value text DEFAULT NULL
) RETURNS text
    AS 'MODULE_PATHNAME', 'mdl_cache'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION mdl_cache IS 'Model cache operations (get/set/clear)';

CREATE FUNCTION mdl_trace(
    model_name text,
    operation text,
    details jsonb DEFAULT '{}'
) RETURNS void
    AS 'MODULE_PATHNAME', 'mdl_trace'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION mdl_trace IS 'Trace model operations for observability';

CREATE FUNCTION create_model(
    model_name text,
    model_type text,
    model_path text,
    options jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'create_model'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_model IS 'Register custom model for inference';

CREATE FUNCTION drop_model(
    model_name text
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'drop_model'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION drop_model IS 'Unregister custom model';

-- Utility and testing functions
CREATE FUNCTION assert_recall(
    ground_truth bigint[],
    results bigint[],
    k integer
) RETURNS real
    AS 'MODULE_PATHNAME', 'assert_recall'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION assert_recall IS 'Assert recall@k metric for testing';

CREATE FUNCTION assert_vector_equal(
    vec1 vector,
    vec2 vector,
    tolerance real DEFAULT 0.0001
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'assert_vector_equal'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION assert_vector_equal IS 'Assert vectors are equal within tolerance';

CREATE FUNCTION explain_vector_query(
    query_text text
) RETURNS TABLE(
    step_num integer,
    operation text,
    index_used text,
    estimated_cost real,
    description text
)
    AS 'MODULE_PATHNAME', 'explain_vector_query'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION explain_vector_query IS 'Explain vector query execution plan';

-- Statistics functions
CREATE FUNCTION pg_stat_neurondb()
    RETURNS TABLE(
        vectors_indexed bigint,
        queries_total bigint,
        cache_hits bigint,
        cache_misses bigint,
        avg_query_time_ms real
    )
    AS 'MODULE_PATHNAME', 'pg_stat_neurondb'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION pg_stat_neurondb IS 'Get NeurondB statistics';

CREATE FUNCTION pg_neurondb_stat_reset() RETURNS void
    AS 'MODULE_PATHNAME', 'pg_neurondb_stat_reset'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION pg_neurondb_stat_reset IS 'Reset NeurondB statistics';

-- Advanced search functions
CREATE FUNCTION graph_knn(
    graph_table text,
    start_node bigint,
    query_vector vector,
    k integer,
    max_hops integer DEFAULT 3
) RETURNS TABLE(node_id bigint, distance real, hops integer)
    AS 'MODULE_PATHNAME', 'graph_knn'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION graph_knn IS 'Graph-aware k-NN search';

CREATE FUNCTION vec_join(
    left_table text,
    right_table text,
    left_vector_col text,
    right_vector_col text,
    k integer DEFAULT 1,
    distance_metric text DEFAULT 'l2'
) RETURNS TABLE(left_id bigint, right_id bigint, distance real)
    AS 'MODULE_PATHNAME', 'vec_join'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION vec_join IS 'Vector similarity join between two tables';

CREATE FUNCTION hybrid_rank(
    vector_score real,
    text_score real,
    metadata_score real DEFAULT 0,
    weights real[] DEFAULT ARRAY[0.5, 0.3, 0.2]
) RETURNS real
    AS 'MODULE_PATHNAME', 'hybrid_rank'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION hybrid_rank IS 'Compute weighted hybrid ranking score';

-- Tenant and security functions
CREATE FUNCTION create_tenant_worker(
    tenant_id text,
    worker_type text DEFAULT 'all'
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'create_tenant_worker'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_tenant_worker IS 'Create dedicated background worker for tenant';

CREATE FUNCTION get_tenant_stats(
    tenant_id text
) RETURNS TABLE(
    vectors bigint,
    storage_mb real,
    qps real,
    indexes integer
)
    AS 'MODULE_PATHNAME', 'get_tenant_stats'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION get_tenant_stats IS 'Get tenant resource usage statistics';

CREATE FUNCTION create_policy(
    policy_name text,
    table_name text,
    expression text,
    role_name text DEFAULT NULL
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'create_policy'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_policy IS 'Create row-level security policy for vector table';

-- Distributed functions
CREATE FUNCTION federated_vector_query(
    remote_servers text[],
    query_vector vector,
    k integer,
    combine_method text DEFAULT 'merge'
) RETURNS TABLE(server text, id bigint, distance real)
    AS 'MODULE_PATHNAME', 'federated_vector_query'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION federated_vector_query IS 'Execute federated vector query across multiple servers';

CREATE FUNCTION enable_vector_replication(
    table_name text,
    replication_mode text DEFAULT 'async'
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'enable_vector_replication'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION enable_vector_replication IS 'Enable vector data replication';

CREATE FUNCTION create_vector_fdw(
    server_name text,
    server_options jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'create_vector_fdw'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_vector_fdw IS 'Create foreign data wrapper for remote vector tables';

-- Security functions
CREATE FUNCTION encrypt_postquantum(
    data vector
) RETURNS bytea
    AS 'MODULE_PATHNAME', 'encrypt_postquantum'
    LANGUAGE C IMMUTABLE;
COMMENT ON FUNCTION encrypt_postquantum IS 'Encrypt vector using post-quantum cryptography';

CREATE FUNCTION enable_confidential_compute(
    table_name text,
    encryption_key bytea
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'enable_confidential_compute'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION enable_confidential_compute IS 'Enable confidential computing for vector table';

CREATE FUNCTION set_access_mask(
    tenant_id text,
    mask_vector vector
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'set_access_mask'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION set_access_mask IS 'Set access control mask for tenant';

-- Feedback and ML lifecycle
CREATE FUNCTION feedback_loop_integrate(
    query_id bigint,
    relevant_ids bigint[],
    feedback_type text DEFAULT 'click'
) RETURNS boolean
    AS 'MODULE_PATHNAME', 'feedback_loop_integrate'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION feedback_loop_integrate IS 'Integrate user feedback for query improvement';

-- Internal/worker functions (exposed for advanced use)
CREATE FUNCTION hnsw_search_layer(
    index_oid oid,
    query_vector vector,
    ef_search integer,
    k integer
) RETURNS TABLE(block_number bigint, distance real)
    AS 'MODULE_PATHNAME', 'hnsw_search_layer'
    LANGUAGE C STABLE;
COMMENT ON FUNCTION hnsw_search_layer IS 'Low-level HNSW layer search (internal)';

CREATE FUNCTION create_hybrid_scan_path(
    table_name text,
    vector_column text,
    text_column text
) RETURNS text
    AS 'MODULE_PATHNAME', 'create_hybrid_scan_path'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_hybrid_scan_path IS 'Create custom scan path for hybrid search (internal)';

-- Audit and testing
CREATE FUNCTION audit_log_query(
    query_text text,
    tenant_id text,
    metadata jsonb DEFAULT '{}'
) RETURNS bigint
    AS 'MODULE_PATHNAME', 'audit_log_query'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION audit_log_query IS 'Log query for audit trail';

CREATE FUNCTION ndb_llm_cache_test() RETURNS boolean
    AS 'MODULE_PATHNAME', 'ndb_llm_cache_test'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION ndb_llm_cache_test IS 'Test LLM cache functionality';

-- Create ANN index (generic wrapper)
CREATE FUNCTION create_ann_index(
    table_name text,
    column_name text,
    index_type text DEFAULT 'hnsw',
    options jsonb DEFAULT '{}'
) RETURNS text
    AS 'MODULE_PATHNAME', 'create_ann_index'
    LANGUAGE C VOLATILE;
COMMENT ON FUNCTION create_ann_index IS 'Create generic ANN index (hnsw/ivf/hybrid)';

-- ============================================================================
-- PERMISSIONS AND GRANTS
-- ============================================================================

-- Grant usage on neurondb schema to public
GRANT USAGE ON SCHEMA neurondb TO PUBLIC;

-- Grant select on all views to public (read-only access)
GRANT SELECT ON neurondb.vector_stats TO PUBLIC;
GRANT SELECT ON neurondb.index_health TO PUBLIC;
GRANT SELECT ON neurondb.tenant_quota_usage TO PUBLIC;
GRANT SELECT ON neurondb.llm_job_status TO PUBLIC;
GRANT SELECT ON neurondb.query_performance TO PUBLIC;
GRANT SELECT ON neurondb.index_maintenance_status TO PUBLIC;
GRANT SELECT ON neurondb.metrics_summary TO PUBLIC;

-- Grant select on configuration and statistics tables to public
GRANT SELECT ON neurondb.llm_config TO PUBLIC;
GRANT SELECT ON neurondb.tenant_usage TO PUBLIC;
GRANT SELECT ON neurondb.tenant_quotas TO PUBLIC;
GRANT SELECT ON neurondb.neurondb_query_metrics TO PUBLIC;
GRANT SELECT ON neurondb.neurondb_prometheus_metrics TO PUBLIC;
GRANT SELECT ON neurondb.neurondb_llm_stats TO PUBLIC;

-- Grant select/insert/update on cache tables to public
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.neurondb_embedding_cache TO PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.neurondb_llm_cache TO PUBLIC;

-- Grant select/insert/update on job tables to public
GRANT SELECT, INSERT, UPDATE ON neurondb.neurondb_job_queue TO PUBLIC;
GRANT SELECT, INSERT, UPDATE ON neurondb.neurondb_llm_jobs TO PUBLIC;

-- Grant select on metadata tables (restricted write)
GRANT SELECT ON neurondb.index_metadata TO PUBLIC;
GRANT SELECT ON neurondb.neurondb_index_maintenance TO PUBLIC;
GRANT SELECT ON neurondb.neurondb_histograms TO PUBLIC;

-- Restricted tables (select only, insert/update via functions)
GRANT SELECT ON neurondb.rls_policies TO PUBLIC;

-- Grant execute on all public functions (C functions)
-- Note: Individual GRANT EXECUTE statements would be too verbose for 180+ functions
-- PostgreSQL allows functions to be executable by PUBLIC by default for LANGUAGE C
-- For security-sensitive functions, we revoke and grant selectively:

-- Revoke execute from public on administrative functions
REVOKE EXECUTE ON FUNCTION neurondb_rebuild_index(regclass) FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION neurondb_reset_quota(text) FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION neurondb_clear_entrypoint_cache() FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION neurondb_ann_buffer_clear() FROM PUBLIC;
REVOKE EXECUTE ON FUNCTION pg_neurondb_stat_reset() FROM PUBLIC;

-- Grant execute on administrative functions to superuser/admin roles only
-- (In production, replace with specific role names like 'neurondb_admin')
-- GRANT EXECUTE ON FUNCTION neurondb_rebuild_index(regclass) TO neurondb_admin;
-- GRANT EXECUTE ON FUNCTION neurondb_reset_quota(text) TO neurondb_admin;
-- GRANT EXECUTE ON FUNCTION neurondb_clear_entrypoint_cache() TO neurondb_admin;
-- GRANT EXECUTE ON FUNCTION neurondb_ann_buffer_clear() TO neurondb_admin;
-- GRANT EXECUTE ON FUNCTION pg_neurondb_stat_reset() TO neurondb_admin;

-- Grant execute on schema helper functions
GRANT EXECUTE ON FUNCTION neurondb.set_llm_config(text, text, text) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.get_llm_config() TO PUBLIC;

-- Revoke write access on sensitive tables from public
REVOKE INSERT, UPDATE, DELETE ON neurondb.tenant_quotas FROM PUBLIC;
REVOKE INSERT, UPDATE, DELETE ON neurondb.rls_policies FROM PUBLIC;
REVOKE INSERT, UPDATE, DELETE ON neurondb.index_metadata FROM PUBLIC;

-- Grant sequence usage for serial columns
GRANT USAGE, SELECT ON SEQUENCE neurondb.rls_policies_policy_id_seq TO PUBLIC;

-- ============================================================================
-- COMMENTS ON SCHEMA
-- ============================================================================

COMMENT ON SCHEMA neurondb IS 'NeurondB extension schema - contains all application tables, views, and metadata';

-- ============================================================================
-- SECURITY LABELS (Optional - for Enhanced Security)
-- ============================================================================

-- Security labels can be added for additional access control
-- SECURITY LABEL FOR sepgsql ON SCHEMA neurondb IS 'system_u:object_r:sepgsql_schema_t:s0';
-- SECURITY LABEL FOR sepgsql ON TABLE neurondb.llm_config IS 'system_u:object_r:sepgsql_table_t:s0';

-- ============================================================================
-- DEFAULT PRIVILEGES (for future objects)
-- ============================================================================

-- Set default privileges for any future tables created in neurondb schema
ALTER DEFAULT PRIVILEGES IN SCHEMA neurondb GRANT SELECT ON TABLES TO PUBLIC;

-- Set default privileges for future views
ALTER DEFAULT PRIVILEGES IN SCHEMA neurondb GRANT SELECT ON TABLES TO PUBLIC;

-- ============================================================================
-- ML TRAINING & INFERENCE API (NeurondB's In-Database ML Framework)
-- ============================================================================

-- =============================================================================
-- ML Project Storage Tables
-- =============================================================================

-- ML Projects table (similar to pgml.projects but NeurondB style)
CREATE TABLE IF NOT EXISTS neurondb.ml_projects (
    project_id SERIAL PRIMARY KEY,
    project_name TEXT UNIQUE NOT NULL,
    description TEXT,
    task_type TEXT CHECK (task_type IN ('classification', 'regression', 'clustering', 'embedding', 'rag')),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
COMMENT ON TABLE neurondb.ml_projects IS 'ML Projects: organize models and experiments';

-- ML Experiments table (track different approaches)
CREATE TABLE IF NOT EXISTS neurondb.ml_experiments (
    experiment_id SERIAL PRIMARY KEY,
    project_id INT REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    experiment_name TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(project_id, experiment_name)
);
COMMENT ON TABLE neurondb.ml_experiments IS 'ML Experiments: track different model configurations';

-- ML Models table (trained model versions)
CREATE TABLE IF NOT EXISTS neurondb.ml_trained_models (
    model_id SERIAL PRIMARY KEY,
    experiment_id INT REFERENCES neurondb.ml_experiments(experiment_id) ON DELETE CASCADE,
    project_id INT REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    algorithm TEXT NOT NULL,
    hyperparameters JSONB,
    metrics JSONB,
    feature_columns TEXT[],
    target_column TEXT,
    model_data BYTEA,  -- Serialized model weights
    status TEXT CHECK (status IN ('training', 'trained', 'deployed', 'archived', 'failed')),
    training_samples BIGINT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    is_default BOOLEAN DEFAULT false
);
COMMENT ON TABLE neurondb.ml_trained_models IS 'Trained ML models with versioning';

-- ML Predictions log (track predictions for monitoring)
CREATE TABLE IF NOT EXISTS neurondb.ml_predictions (
    prediction_id BIGSERIAL PRIMARY KEY,
    model_id INT REFERENCES neurondb.ml_trained_models(model_id) ON DELETE CASCADE,
    project_id INT REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    input_features JSONB,
    prediction FLOAT,
    probabilities FLOAT[],
    predicted_at TIMESTAMPTZ DEFAULT NOW()
);
COMMENT ON TABLE neurondb.ml_predictions IS 'Prediction log for monitoring and A/B testing';

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_ml_projects_name ON neurondb.ml_projects(project_name);
CREATE INDEX IF NOT EXISTS idx_ml_experiments_project ON neurondb.ml_experiments(project_id);
CREATE INDEX IF NOT EXISTS idx_ml_models_experiment ON neurondb.ml_trained_models(experiment_id);
CREATE INDEX IF NOT EXISTS idx_ml_models_project ON neurondb.ml_trained_models(project_id);
CREATE INDEX IF NOT EXISTS idx_ml_models_default ON neurondb.ml_trained_models(project_id, is_default) WHERE is_default = true;
CREATE INDEX IF NOT EXISTS idx_ml_predictions_model ON neurondb.ml_predictions(model_id);
CREATE INDEX IF NOT EXISTS idx_ml_predictions_time ON neurondb.ml_predictions(predicted_at);

-- =============================================================================
-- Project Management Functions
-- =============================================================================

-- Create ML project
CREATE OR REPLACE FUNCTION neurondb.create_project(
    project_name TEXT,
    task_type TEXT DEFAULT 'classification',
    description TEXT DEFAULT NULL
) RETURNS INT
LANGUAGE plpgsql
AS $$
DECLARE
    new_id INT;
BEGIN
    INSERT INTO neurondb.ml_projects (project_name, task_type, description)
    VALUES (project_name, task_type, description)
    RETURNING project_id INTO new_id;
    RETURN new_id;
END;
$$;
COMMENT ON FUNCTION neurondb.create_project IS 'Create ML project: organizes models and experiments';

-- Create experiment within a project
CREATE OR REPLACE FUNCTION neurondb.create_experiment(
    project_name TEXT,
    experiment_name TEXT,
    description TEXT DEFAULT NULL
) RETURNS INT
LANGUAGE plpgsql
AS $$
DECLARE
    proj_id INT;
    exp_id INT;
BEGIN
    SELECT project_id INTO proj_id
    FROM neurondb.ml_projects
    WHERE ml_projects.project_name = create_experiment.project_name;
    
    IF proj_id IS NULL THEN
        RAISE EXCEPTION 'Project % not found', project_name;
    END IF;
    
    INSERT INTO neurondb.ml_experiments (project_id, experiment_name, description)
    VALUES (proj_id, experiment_name, description)
    RETURNING experiment_id INTO exp_id;
    
    RETURN exp_id;
END;
$$;
COMMENT ON FUNCTION neurondb.create_experiment IS 'Create experiment: track different model approaches';

-- List projects
CREATE OR REPLACE FUNCTION neurondb.list_projects()
RETURNS TABLE(
    project_id INT,
    project_name TEXT,
    task_type TEXT,
    num_models BIGINT,
    created_at TIMESTAMPTZ
)
LANGUAGE SQL
AS $$
    SELECT 
        p.project_id,
        p.project_name,
        p.task_type,
        COUNT(m.model_id) as num_models,
        p.created_at
    FROM neurondb.ml_projects p
    LEFT JOIN neurondb.ml_trained_models m ON p.project_id = m.project_id
    GROUP BY p.project_id, p.project_name, p.task_type, p.created_at
    ORDER BY p.created_at DESC;
$$;
COMMENT ON FUNCTION neurondb.list_projects IS 'List all ML projects with statistics';

-- =============================================================================
-- Model Training Functions (Enhanced with Project Support)
-- =============================================================================

-- Train model with project/experiment
CREATE OR REPLACE FUNCTION neurondb.train_model(
    model_name TEXT,
    algorithm TEXT,
    training_table TEXT,
    feature_columns TEXT[],
    target_column TEXT,
    validation_split FLOAT DEFAULT 0.2,
    hyperparameters JSONB DEFAULT '{}',
    random_state INT DEFAULT 42
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
    result JSONB;
BEGIN
    -- TODO: Implement full model training
    -- For now, return a placeholder
    result := jsonb_build_object(
        'model_name', model_name,
        'algorithm', algorithm,
        'status', 'trained',
        'message', 'Model training API - implementation pending'
    );
    RETURN result;
END;
$$;
COMMENT ON FUNCTION neurondb.train_model IS 'Train ML model: supports classification, regression, clustering algorithms';

-- Hyperparameter tuning function
CREATE OR REPLACE FUNCTION neurondb.tune_model(
    model_name TEXT,
    algorithm TEXT,
    training_table TEXT,
    feature_columns TEXT[],
    target_column TEXT,
    param_grid JSONB,
    search_strategy TEXT DEFAULT 'grid',
    cv_folds INT DEFAULT 5,
    n_iter INT DEFAULT 10
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN jsonb_build_object(
        'model_name', model_name,
        'best_params', param_grid,
        'status', 'tuned'
    );
END;
$$;
COMMENT ON FUNCTION neurondb.tune_model IS 'Hyperparameter tuning: grid or random search with cross-validation';

-- =============================================================================
-- Prediction & Inference Functions
-- =============================================================================

-- Single prediction
CREATE OR REPLACE FUNCTION neurondb.predict(
    model_name TEXT,
    features ANYARRAY
) RETURNS FLOAT
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement model prediction
    RETURN 0.0;
END;
$$;
COMMENT ON FUNCTION neurondb.predict IS 'Make prediction using trained model: returns single prediction value';

-- Probability prediction
CREATE OR REPLACE FUNCTION neurondb.predict_proba(
    model_name TEXT,
    features ANYARRAY
) RETURNS FLOAT[]
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement probability prediction
    RETURN ARRAY[0.5, 0.5];
END;
$$;
COMMENT ON FUNCTION neurondb.predict_proba IS 'Get probability scores for each class';

-- Batch prediction
CREATE OR REPLACE FUNCTION neurondb.predict_batch(
    model_name TEXT,
    feature_table TEXT,
    feature_columns TEXT[],
    output_column TEXT DEFAULT 'prediction'
) RETURNS BIGINT
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement batch prediction
    RETURN 0;
END;
$$;
COMMENT ON FUNCTION neurondb.predict_batch IS 'Efficient batch prediction: adds predictions to existing table';

-- =============================================================================
-- Embedding Generation Functions
-- =============================================================================

-- Generate single embedding
CREATE OR REPLACE FUNCTION neurondb.generate_embedding(
    model TEXT,
    text TEXT,
    should_normalize BOOLEAN DEFAULT true
) RETURNS vector
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Integrate with existing embed functions or implement new
    -- For now, return a placeholder zero vector
    RETURN '[0,0,0,0]'::vector;
END;
$$;
COMMENT ON FUNCTION neurondb.generate_embedding IS 'Generate vector embedding from text: supports multiple pre-trained models';

-- Batch embedding generation
CREATE OR REPLACE FUNCTION neurondb.batch_embed(
    model TEXT,
    source_table TEXT,
    text_column TEXT,
    embedding_column TEXT,
    batch_size INT DEFAULT 32,
    where_clause TEXT DEFAULT NULL
) RETURNS BIGINT
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement batch embedding
    RETURN 0;
END;
$$;
COMMENT ON FUNCTION neurondb.batch_embed IS 'Efficient batch embedding: generates embeddings for entire table';

-- =============================================================================
-- RAG Pipeline Functions
-- =============================================================================

-- Text chunking for RAG
CREATE OR REPLACE FUNCTION neurondb.chunk_text(
    text TEXT,
    strategy TEXT DEFAULT 'sentence',
    chunk_size INT DEFAULT 512,
    overlap INT DEFAULT 50
) RETURNS TABLE(chunk_id INT, chunk_text TEXT, start_pos INT, end_pos INT)
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement text chunking with different strategies
    RETURN QUERY SELECT 1, text, 0, LENGTH(text);
END;
$$;
COMMENT ON FUNCTION neurondb.chunk_text IS 'Split text into chunks: sentence, paragraph, fixed, token, semantic strategies';

-- Retrieve relevant context
CREATE OR REPLACE FUNCTION neurondb.retrieve_context(
    query TEXT,
    source_table TEXT,
    embedding_column TEXT,
    text_column TEXT,
    model TEXT DEFAULT 'minilm-l6',
    top_k INT DEFAULT 5,
    where_clause TEXT DEFAULT NULL
) RETURNS TABLE(id BIGINT, text TEXT, score FLOAT)
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement context retrieval with vector similarity
    RETURN QUERY SELECT 0::BIGINT, query, 1.0;
END;
$$;
COMMENT ON FUNCTION neurondb.retrieve_context IS 'Retrieve relevant chunks for query: vector similarity search';

-- Rerank results
CREATE OR REPLACE FUNCTION neurondb.rerank_results(
    query TEXT,
    candidates_table TEXT,
    text_column TEXT,
    model TEXT DEFAULT 'cross-encoder-ms-marco',
    top_k INT DEFAULT 5
) RETURNS TABLE(id BIGINT, text TEXT, score FLOAT)
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement cross-encoder reranking
    RETURN QUERY SELECT 0::BIGINT, query, 1.0;
END;
$$;
COMMENT ON FUNCTION neurondb.rerank_results IS 'Rerank retrieved results: cross-encoder for better precision';

-- Generate answer using LLM
CREATE OR REPLACE FUNCTION neurondb.generate_answer(
    query TEXT,
    context TEXT[],
    model TEXT DEFAULT 'gpt-3.5-turbo',
    max_tokens INT DEFAULT 512,
    temperature FLOAT DEFAULT 0.7
) RETURNS TEXT
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Integrate with existing LLM functions or implement new
    RETURN 'Answer generation pending implementation';
END;
$$;
COMMENT ON FUNCTION neurondb.generate_answer IS 'Generate answer from context: completes RAG pipeline';

-- =============================================================================
-- Model Management Functions
-- =============================================================================

-- List all models
CREATE OR REPLACE FUNCTION neurondb.list_models()
RETURNS TABLE(
    model_name TEXT,
    algorithm TEXT,
    version TEXT,
    accuracy FLOAT,
    created_at TIMESTAMPTZ,
    status TEXT
)
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Query from model registry table
    RETURN QUERY SELECT 
        'example_model'::TEXT,
        'random_forest'::TEXT,
        'v1'::TEXT,
        0.95::FLOAT,
        NOW(),
        'active'::TEXT
    LIMIT 0;
END;
$$;
COMMENT ON FUNCTION neurondb.list_models IS 'List all trained models with metadata';

-- Get model information
CREATE OR REPLACE FUNCTION neurondb.model_info(
    model_name TEXT
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN jsonb_build_object(
        'model_name', model_name,
        'status', 'Model info API - implementation pending'
    );
END;
$$;
COMMENT ON FUNCTION neurondb.model_info IS 'Get detailed model information: metrics, features, hyperparameters';

-- Delete model
CREATE OR REPLACE FUNCTION neurondb.delete_model(
    model_name TEXT
) RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement model deletion
    RETURN true;
END;
$$;
COMMENT ON FUNCTION neurondb.delete_model IS 'Delete trained model and associated metadata';

-- Import external model
CREATE OR REPLACE FUNCTION neurondb.import_model(
    model_name TEXT,
    source TEXT,
    model_path TEXT,
    model_config JSONB DEFAULT '{}'
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN jsonb_build_object(
        'model_name', model_name,
        'source', source,
        'status', 'imported'
    );
END;
$$;
COMMENT ON FUNCTION neurondb.import_model IS 'Import pre-trained model: Hugging Face, ONNX, pickle, sklearn';

-- Feature extraction
CREATE OR REPLACE FUNCTION neurondb.extract_features(
    source_table TEXT,
    feature_config JSONB
) RETURNS TABLE(id BIGINT, features FLOAT[])
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY SELECT 0::BIGINT, ARRAY[0.0];
END;
$$;
COMMENT ON FUNCTION neurondb.extract_features IS 'Automated feature extraction: statistical, temporal, categorical';

-- Model performance monitoring
CREATE OR REPLACE FUNCTION neurondb.model_performance(
    model_name TEXT,
    start_date TIMESTAMPTZ DEFAULT NULL,
    end_date TIMESTAMPTZ DEFAULT NOW()
) RETURNS TABLE(
    date DATE,
    predictions BIGINT,
    accuracy FLOAT,
    model_precision FLOAT,
    recall FLOAT,
    drift_score FLOAT
)
LANGUAGE plpgsql
AS $$
BEGIN
    RETURN QUERY SELECT 
        CURRENT_DATE,
        0::BIGINT,
        0.0::FLOAT,
        0.0::FLOAT,
        0.0::FLOAT,
        0.0::FLOAT
    LIMIT 0;
END;
$$;
COMMENT ON FUNCTION neurondb.model_performance IS 'Monitor model performance over time: accuracy, drift detection';

-- =============================================================================
-- Grant execute permissions on ML API functions
-- =============================================================================

-- Additional advanced ML training functions
CREATE OR REPLACE FUNCTION neurondb.train_with_search(
    project_name TEXT,
    relation TEXT,
    target_column TEXT,
    feature_columns TEXT[],
    algorithm TEXT DEFAULT 'xgboost',
    search_type TEXT DEFAULT 'grid',
    search_params JSONB DEFAULT '{"max_trials": 20, "cv": 5}',
    preprocess TEXT DEFAULT NULL
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement hyperparameter search (grid, random, bayesian)
    RETURN jsonb_build_object(
        'project', project_name,
        'best_model_id', 0,
        'best_score', 0.95,
        'search_type', search_type,
        'trials_completed', 20
    );
END;
$$;
COMMENT ON FUNCTION neurondb.train_with_search IS 'Train with automatic hyperparameter search: grid, random, or bayesian';

-- Set default model for a project
CREATE OR REPLACE FUNCTION neurondb.set_default_model(
    project_name TEXT,
    model_id_param INT
) RETURNS BOOLEAN
LANGUAGE plpgsql
AS $$
DECLARE
    proj_id INT;
BEGIN
    SELECT project_id INTO proj_id
    FROM neurondb.ml_projects
    WHERE ml_projects.project_name = set_default_model.project_name;
    
    IF proj_id IS NULL THEN
        RAISE EXCEPTION 'Project % not found', project_name;
    END IF;
    
    -- Unset all default flags for this project
    UPDATE neurondb.ml_trained_models
    SET is_default = false
    WHERE project_id = proj_id;
    
    -- Set new default
    UPDATE neurondb.ml_trained_models
    SET is_default = true
    WHERE model_id = model_id_param AND project_id = proj_id;
    
    RETURN true;
END;
$$;
COMMENT ON FUNCTION neurondb.set_default_model IS 'Set default model for project: used for A/B testing and version control';

-- Explain prediction (feature importance)
CREATE OR REPLACE FUNCTION neurondb.explain_prediction(
    project_name TEXT,
    input_features JSONB
) RETURNS JSONB
LANGUAGE plpgsql
AS $$
BEGIN
    -- TODO: Implement SHAP-style feature importance
    RETURN jsonb_build_object(
        'prediction', 0.85,
        'feature_importance', jsonb_build_object(
            'feature1', 0.35,
            'feature2', 0.25,
            'feature3', 0.20
        )
    );
END;
$$;
COMMENT ON FUNCTION neurondb.explain_prediction IS 'Explain prediction: feature importance and contributions';

-- View recent predictions
CREATE OR REPLACE VIEW neurondb.recent_predictions AS
SELECT 
    p.project_name,
    m.algorithm,
    pred.prediction,
    pred.input_features,
    pred.predicted_at
FROM neurondb.ml_predictions pred
JOIN neurondb.ml_trained_models m ON pred.model_id = m.model_id
JOIN neurondb.ml_projects p ON pred.project_id = p.project_id
WHERE pred.predicted_at > NOW() - INTERVAL '24 hours'
ORDER BY pred.predicted_at DESC;

COMMENT ON VIEW neurondb.recent_predictions IS 'Recent predictions (last 24 hours) for monitoring';

-- =============================================================================
-- Grant execute permissions on all ML API functions
-- =============================================================================

-- Project management
GRANT EXECUTE ON FUNCTION neurondb.create_project(TEXT, TEXT, TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.create_experiment(TEXT, TEXT, TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.list_projects() TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.set_default_model(TEXT, INT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.explain_prediction(TEXT, JSONB) TO PUBLIC;

-- Model training and inference
GRANT EXECUTE ON FUNCTION neurondb.train_model(TEXT, TEXT, TEXT, TEXT[], TEXT, FLOAT, JSONB, INT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.train_with_search(TEXT, TEXT, TEXT, TEXT[], TEXT, TEXT, JSONB, TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.tune_model(TEXT, TEXT, TEXT, TEXT[], TEXT, JSONB, TEXT, INT, INT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.predict(TEXT, ANYARRAY) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.predict_proba(TEXT, ANYARRAY) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.predict_batch(TEXT, TEXT, TEXT[], TEXT) TO PUBLIC;

-- Embeddings and RAG
GRANT EXECUTE ON FUNCTION neurondb.generate_embedding(TEXT, TEXT, BOOLEAN) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.batch_embed(TEXT, TEXT, TEXT, TEXT, INT, TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.chunk_text(TEXT, TEXT, INT, INT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.retrieve_context(TEXT, TEXT, TEXT, TEXT, TEXT, INT, TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.rerank_results(TEXT, TEXT, TEXT, TEXT, INT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.generate_answer(TEXT, TEXT[], TEXT, INT, FLOAT) TO PUBLIC;

-- Model management
GRANT EXECUTE ON FUNCTION neurondb.list_models() TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.model_info(TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.delete_model(TEXT) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.import_model(TEXT, TEXT, TEXT, JSONB) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.extract_features(TEXT, JSONB) TO PUBLIC;
GRANT EXECUTE ON FUNCTION neurondb.model_performance(TEXT, TIMESTAMPTZ, TIMESTAMPTZ) TO PUBLIC;

-- Grant permissions on tables
GRANT SELECT ON neurondb.ml_projects TO PUBLIC;
GRANT SELECT ON neurondb.ml_experiments TO PUBLIC;
GRANT SELECT ON neurondb.ml_trained_models TO PUBLIC;
GRANT SELECT ON neurondb.ml_predictions TO PUBLIC;
GRANT SELECT ON neurondb.recent_predictions TO PUBLIC;

-- Grant sequence usage
GRANT USAGE, SELECT ON SEQUENCE neurondb.ml_projects_project_id_seq TO PUBLIC;
GRANT USAGE, SELECT ON SEQUENCE neurondb.ml_experiments_experiment_id_seq TO PUBLIC;
GRANT USAGE, SELECT ON SEQUENCE neurondb.ml_trained_models_model_id_seq TO PUBLIC;
GRANT USAGE, SELECT ON SEQUENCE neurondb.ml_predictions_prediction_id_seq TO PUBLIC;

-- ============================================================================
-- EXTENSION METADATA
-- ============================================================================

-- Extension is now fully initialized and secured
-- All objects are properly organized in the neurondb schema
-- Type system objects remain in public schema (PostgreSQL requirement)

-- ML Training & Inference API added for in-database machine learning
-- Compatible with Hugging Face models, ONNX, and custom algorithms

-- End of NeurondB extension

-- =============================================================================
-- Unified ML API (PostgresML-compatible)
-- =============================================================================

CREATE OR REPLACE FUNCTION neurondb.train(
    project_name TEXT,
    algorithm TEXT,
    table_name TEXT,
    target_column TEXT,
    feature_columns TEXT[] DEFAULT NULL,
    hyperparams JSONB DEFAULT NULL
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_train'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.train IS 'Unified ML training interface - train any algorithm with one call';

CREATE OR REPLACE FUNCTION neurondb.predict(
    model_id INTEGER,
    features ANYARRAY
)
RETURNS FLOAT8
AS 'MODULE_PATHNAME', 'neurondb_predict'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.predict IS 'Unified prediction interface - predict with any trained model';

CREATE OR REPLACE FUNCTION neurondb.deploy(
    model_id INTEGER,
    strategy TEXT DEFAULT 'replace'
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_deploy'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.deploy IS 'Deploy model to production with strategy (replace, blue_green, canary)';

CREATE OR REPLACE FUNCTION neurondb.load_model(
    project_name TEXT,
    model_path TEXT,
    model_format TEXT
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_load_model'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.load_model IS 'Load external model (onnx, tensorflow, pytorch, sklearn)';

-- =============================================================================
-- RAG Pipeline Functions
-- =============================================================================

CREATE OR REPLACE FUNCTION neurondb.chunk(
    text TEXT,
    chunk_size INTEGER DEFAULT 512,
    overlap INTEGER DEFAULT 128,
    separator TEXT DEFAULT E'\n\n'
)
RETURNS TEXT[]
AS 'MODULE_PATHNAME', 'neurondb_chunk_text'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.chunk IS 'Chunk text for RAG with configurable size and overlap';

CREATE OR REPLACE FUNCTION neurondb.embed(
    model TEXT,
    text TEXT,
    use_gpu BOOLEAN DEFAULT true
)
RETURNS vector
AS 'MODULE_PATHNAME', 'neurondb_embed_text'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.embed IS 'Generate embeddings with GPU support';

CREATE OR REPLACE FUNCTION neurondb.rank(
    query TEXT,
    documents TEXT[],
    algorithm TEXT DEFAULT 'bm25'
)
RETURNS TABLE(document TEXT, score FLOAT8, rank INTEGER)
AS 'MODULE_PATHNAME', 'neurondb_rank_documents'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.rank IS 'Rerank documents based on query relevance';

CREATE OR REPLACE FUNCTION neurondb.transform(
    pipeline TEXT,
    data ANYARRAY
)
RETURNS ANYARRAY
AS 'MODULE_PATHNAME', 'neurondb_transform_data'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.transform IS 'Apply data transformations (normalize, standardize, min_max)';

-- =============================================================================
-- Feature Store Functions
-- =============================================================================

CREATE OR REPLACE FUNCTION neurondb.create_feature_store(
    store_name TEXT,
    entity_table TEXT,
    entity_key TEXT
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_create_feature_store'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.create_feature_store IS 'Initialize feature store for entity';

CREATE OR REPLACE FUNCTION neurondb.register_feature(
    store_id INTEGER,
    feature_name TEXT,
    feature_type TEXT,
    transformation TEXT DEFAULT NULL
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_register_feature'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.register_feature IS 'Register feature definition with transformation';

CREATE OR REPLACE FUNCTION neurondb.get_features(
    store_name TEXT,
    entity_ids TEXT[],
    feature_names TEXT[] DEFAULT NULL
)
RETURNS TABLE(entity_id TEXT, features JSONB)
AS 'MODULE_PATHNAME', 'neurondb_get_features'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.get_features IS 'Retrieve features for entities';

CREATE OR REPLACE FUNCTION neurondb.feature_engineering(
    store_id INTEGER,
    pipeline JSONB,
    source_table TEXT
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'neurondb_feature_engineering'
LANGUAGE C STRICT;
COMMENT ON FUNCTION neurondb.feature_engineering IS 'Apply automated feature engineering pipeline';

-- =============================================================================
-- Hyperparameter Tuning Functions
-- =============================================================================

CREATE OR REPLACE FUNCTION neurondb.grid_search(
    project_name TEXT,
    algorithm TEXT,
    param_grid JSONB,
    cv_folds INTEGER DEFAULT 5
)
RETURNS TABLE(params JSONB, score FLOAT8, model_id INTEGER)
AS 'MODULE_PATHNAME', 'neurondb_grid_search'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.grid_search IS 'Grid search hyperparameter optimization';

CREATE OR REPLACE FUNCTION neurondb.random_search(
    project_name TEXT,
    algorithm TEXT,
    param_distributions JSONB,
    n_iter INTEGER DEFAULT 10,
    cv_folds INTEGER DEFAULT 5
)
RETURNS TABLE(params JSONB, score FLOAT8, model_id INTEGER)
AS 'MODULE_PATHNAME', 'neurondb_random_search'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.random_search IS 'Random search hyperparameter optimization';

CREATE OR REPLACE FUNCTION neurondb.bayesian_optimize(
    project_name TEXT,
    algorithm TEXT,
    param_space JSONB,
    n_calls INTEGER DEFAULT 20,
    acquisition_function TEXT DEFAULT 'ei'
)
RETURNS TABLE(params JSONB, score FLOAT8, model_id INTEGER)
AS 'MODULE_PATHNAME', 'neurondb_bayesian_optimize'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.bayesian_optimize IS 'Bayesian optimization for hyperparameters';

-- =============================================================================
-- Text ML Functions
-- =============================================================================

CREATE OR REPLACE FUNCTION neurondb.text_classify(
    model_id INTEGER,
    text TEXT
)
RETURNS TABLE(category TEXT, confidence FLOAT8)
AS 'MODULE_PATHNAME', 'neurondb_text_classify'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.text_classify IS 'Text classification with confidence scores';

CREATE OR REPLACE FUNCTION neurondb.sentiment_analysis(
    text TEXT,
    model TEXT DEFAULT 'vader'
)
RETURNS TABLE(sentiment TEXT, positive FLOAT8, negative FLOAT8, neutral FLOAT8)
AS 'MODULE_PATHNAME', 'neurondb_sentiment_analysis'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.sentiment_analysis IS 'Sentiment analysis with scores';

CREATE OR REPLACE FUNCTION neurondb.named_entity_recognition(
    text TEXT,
    entity_types TEXT[] DEFAULT NULL
)
RETURNS TABLE(entity TEXT, entity_type TEXT, confidence FLOAT8, entity_position INTEGER)
AS 'MODULE_PATHNAME', 'neurondb_named_entity_recognition'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.named_entity_recognition IS 'Named entity recognition (NER)';

CREATE OR REPLACE FUNCTION neurondb.text_summarize(
    text TEXT,
    max_length INTEGER DEFAULT 128,
    method TEXT DEFAULT 'extractive'
)
RETURNS TEXT
AS 'MODULE_PATHNAME', 'neurondb_text_summarize'
LANGUAGE C;
COMMENT ON FUNCTION neurondb.text_summarize IS 'Text summarization (extractive or abstractive)';

-- =============================================================================
-- XGBoost Integration
-- =============================================================================

CREATE OR REPLACE FUNCTION train_xgboost_classifier(
    table_name TEXT,
    feature_col TEXT,
    label_col TEXT,
    n_estimators INTEGER DEFAULT 100,
    max_depth INTEGER DEFAULT 6,
    learning_rate FLOAT DEFAULT 0.3
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_xgboost_classifier'
LANGUAGE C;
COMMENT ON FUNCTION train_xgboost_classifier IS 'Train XGBoost gradient boosting classifier';

CREATE OR REPLACE FUNCTION train_xgboost_regressor(
    table_name TEXT,
    feature_col TEXT,
    target_col TEXT,
    n_estimators INTEGER DEFAULT 100,
    max_depth INTEGER DEFAULT 6,
    learning_rate FLOAT DEFAULT 0.3
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_xgboost_regressor'
LANGUAGE C;
COMMENT ON FUNCTION train_xgboost_regressor IS 'Train XGBoost gradient boosting regressor';

CREATE OR REPLACE FUNCTION predict_xgboost(
    model_id INTEGER,
    features REAL[]
)
RETURNS FLOAT8
AS 'MODULE_PATHNAME', 'predict_xgboost'
LANGUAGE C STRICT;
COMMENT ON FUNCTION predict_xgboost IS 'Predict with XGBoost model';

-- =============================================================================
-- LightGBM Integration
-- =============================================================================

CREATE OR REPLACE FUNCTION train_lightgbm_classifier(
    table_name TEXT,
    feature_col TEXT,
    label_col TEXT,
    n_estimators INTEGER DEFAULT 100,
    num_leaves INTEGER DEFAULT 31,
    learning_rate FLOAT DEFAULT 0.1
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_lightgbm_classifier'
LANGUAGE C;
COMMENT ON FUNCTION train_lightgbm_classifier IS 'Train LightGBM classifier';

CREATE OR REPLACE FUNCTION train_lightgbm_regressor(
    table_name TEXT,
    feature_col TEXT,
    target_col TEXT,
    n_estimators INTEGER DEFAULT 100
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_lightgbm_regressor'
LANGUAGE C;
COMMENT ON FUNCTION train_lightgbm_regressor IS 'Train LightGBM regressor';

CREATE OR REPLACE FUNCTION predict_lightgbm(
    model_id INTEGER,
    features REAL[]
)
RETURNS FLOAT8
AS 'MODULE_PATHNAME', 'predict_lightgbm'
LANGUAGE C STRICT;
COMMENT ON FUNCTION predict_lightgbm IS 'Predict with LightGBM model';

-- =============================================================================
-- CatBoost Integration
-- =============================================================================

CREATE OR REPLACE FUNCTION train_catboost_classifier(
    table_name TEXT,
    feature_col TEXT,
    label_col TEXT,
    iterations INTEGER DEFAULT 1000,
    learning_rate FLOAT DEFAULT 0.03,
    depth INTEGER DEFAULT 6
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_catboost_classifier'
LANGUAGE C;
COMMENT ON FUNCTION train_catboost_classifier IS 'Train CatBoost classifier';

CREATE OR REPLACE FUNCTION train_catboost_regressor(
    table_name TEXT,
    feature_col TEXT,
    target_col TEXT,
    iterations INTEGER DEFAULT 1000
)
RETURNS INTEGER
AS 'MODULE_PATHNAME', 'train_catboost_regressor'
LANGUAGE C;
COMMENT ON FUNCTION train_catboost_regressor IS 'Train CatBoost regressor';

CREATE OR REPLACE FUNCTION predict_catboost(
    model_id INTEGER,
    features REAL[]
)
RETURNS FLOAT8
AS 'MODULE_PATHNAME', 'predict_catboost'
LANGUAGE C STRICT;
COMMENT ON FUNCTION predict_catboost IS 'Predict with CatBoost model';

-- =============================================================================
-- End of NeuronDB Extension
-- =============================================================================
-- ============================================================================
-- ML Unified API Schema
-- PostgresML-compatible unified interface for NeuronDB
-- ============================================================================

-- Feature Stores Table
CREATE TABLE IF NOT EXISTS neurondb.feature_stores (
    store_id SERIAL PRIMARY KEY,
    store_name TEXT UNIQUE NOT NULL,
    entity_table TEXT NOT NULL,
    entity_key TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Feature Definitions Table
CREATE TABLE IF NOT EXISTS neurondb.features (
    feature_id SERIAL PRIMARY KEY,
    store_id INTEGER REFERENCES neurondb.feature_stores(store_id) ON DELETE CASCADE,
    feature_name TEXT NOT NULL,
    feature_type TEXT NOT NULL CHECK (feature_type IN ('numeric', 'categorical', 'vector', 'text')),
    transformation TEXT,
    version INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(store_id, feature_name, version)
);

-- Hyperparameter Tuning Results
CREATE TABLE IF NOT EXISTS neurondb.hyperparameter_results (
    result_id SERIAL PRIMARY KEY,
    project_id INTEGER REFERENCES neurondb.ml_projects(project_id) ON DELETE CASCADE,
    algorithm TEXT NOT NULL,
    parameters JSONB NOT NULL,
    score FLOAT NOT NULL,
    cv_scores FLOAT[] NOT NULL,
    training_time_ms INTEGER,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_hyperparam_project ON neurondb.hyperparameter_results(project_id);
CREATE INDEX IF NOT EXISTS idx_hyperparam_score ON neurondb.hyperparameter_results(score DESC);

-- Text ML Models
CREATE TABLE IF NOT EXISTS neurondb.text_models (
    model_id SERIAL PRIMARY KEY,
    model_name TEXT UNIQUE NOT NULL,
    model_type TEXT NOT NULL CHECK (model_type IN ('classification', 'sentiment', 'ner', 'summarization')),
    model_path TEXT,
    vocabulary_size INTEGER,
    embedding_dim INTEGER,
    metadata JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- RAG Pipeline Configurations
CREATE TABLE IF NOT EXISTS neurondb.rag_pipelines (
    pipeline_id SERIAL PRIMARY KEY,
    pipeline_name TEXT UNIQUE NOT NULL,
    chunk_size INTEGER DEFAULT 512,
    chunk_overlap INTEGER DEFAULT 128,
    embedding_model TEXT NOT NULL,
    reranking_model TEXT,
    configuration JSONB,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Grant permissions
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.feature_stores TO PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.features TO PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.hyperparameter_results TO PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.text_models TO PUBLIC;
GRANT SELECT, INSERT, UPDATE, DELETE ON neurondb.rag_pipelines TO PUBLIC;

GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA neurondb TO PUBLIC;

-- Comments
COMMENT ON TABLE neurondb.feature_stores IS 'Feature store registry for ML feature management';
COMMENT ON TABLE neurondb.features IS 'Feature definitions with versioning';
COMMENT ON TABLE neurondb.hyperparameter_results IS 'Hyperparameter tuning results';
COMMENT ON TABLE neurondb.text_models IS 'Text ML model registry';
COMMENT ON TABLE neurondb.rag_pipelines IS 'RAG pipeline configurations';

