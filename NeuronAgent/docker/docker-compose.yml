version: '3.9'

# NeuronAgent Docker Compose Configuration
# Standalone service that connects to external NeuronDB instance
# Configure connection via environment variables or .env file

services:
  agent-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: neuronagent:latest
    container_name: neuronagent
    ports:
      - "8080:8080"
    environment:
      # Database connection - point to external NeuronDB instance
      # When connecting to NeuronDB in Docker, use container name or host.docker.internal
      DB_HOST: ${DB_HOST:-localhost}
      DB_PORT: ${DB_PORT:-5433}
      DB_NAME: ${DB_NAME:-neurondb}
      DB_USER: ${DB_USER:-neurondb}
      DB_PASSWORD: ${DB_PASSWORD:-neurondb}
      
      # Server configuration
      SERVER_HOST: ${SERVER_HOST:-0.0.0.0}
      SERVER_PORT: ${SERVER_PORT:-8080}
      SERVER_READ_TIMEOUT: ${SERVER_READ_TIMEOUT:-30s}
      SERVER_WRITE_TIMEOUT: ${SERVER_WRITE_TIMEOUT:-30s}
      
      # Database connection pool
      DB_MAX_OPEN_CONNS: ${DB_MAX_OPEN_CONNS:-25}
      DB_MAX_IDLE_CONNS: ${DB_MAX_IDLE_CONNS:-5}
      DB_CONN_MAX_LIFETIME: ${DB_CONN_MAX_LIFETIME:-5m}
      
      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
      LOG_FORMAT: ${LOG_FORMAT:-json}
      
      # Optional: Path to config file
      CONFIG_PATH: ${CONFIG_PATH:-}
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    restart: unless-stopped
    networks:
      - default
    # Optional: mount migrations for development (already included in image)
    # volumes:
    #   - ../migrations:/app/migrations:ro

networks:
  default:
    name: neuronagent-network
    driver: bridge

